<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.6.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.6.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '6.6.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false,"padding":18},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="HuZhenXing">
<meta property="og:url" content="https://hzxgoforward.github.io/index.html">
<meta property="og:site_name" content="HuZhenXing">
<meta property="og:locale">
<meta property="article:author" content="hzx">
<meta name="twitter:card" content="summary">






  <link rel="canonical" href="https://hzxgoforward.github.io/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>HuZhenXing</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HuZhenXing</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">与其感慨路难行，不如马上出发!</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hzxgoforward.github.io/2023/12/28/HotStuff%20%E5%8D%8F%E8%AE%AE%E7%9A%84%E7%90%86%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="博主">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuZhenXing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2023/12/28/HotStuff%20%E5%8D%8F%E8%AE%AE%E7%9A%84%E7%90%86%E8%A7%A3/" class="post-title-link" itemprop="https://hzxgoforward.github.io/index.html">HotStuff 协议的理解</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建于：2023-12-28 18:04:54 / 更新于：19:54:31" itemprop="dateCreated datePublished" datetime="2023-12-28T18:04:54+08:00">2023-12-28</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%85%B1%E8%AF%86%E5%8D%8F%E8%AE%AE/" itemprop="url" rel="index"><span itemprop="name">共识协议</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          


          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="hotstuff-协议的理解"><a class="markdownIt-Anchor" href="#hotstuff-协议的理解"></a> HotStuff 协议的理解</h1>
<h2 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h2>
<p>HotStuff是继 PBFT 之后 BFT 共识协议中又一里程碑。它具有更低的消息复杂度和更好的扩展性。它的优点如下：</p>
<ol>
<li>将共识节点之间完成一轮共识的消息复杂度降低到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mi mathvariant="script">n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O(n)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span> 级别，其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> 表示消息的数量。与之相比，PBFT中共识节点完成一轮共识的消息复杂度是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mi mathvariant="script">n</mi><mn mathvariant="script">2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O(n^2)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 级别。</li>
<li>将更换主节点的消息复杂度降低到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mi mathvariant="script">n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O(n)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span> 级别。与之相比，PBFT中更换主节点的消息复杂度是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mi mathvariant="script">n</mi><mn mathvariant="script">3</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O(n^3)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>。</li>
</ol>
<p>HotStuff 协议的第一个优点使得它具有更好的扩展性，即当共识组中共识节点数量线性增加时，节点间进行共识的消息复杂度仅仅是线性增加。做过分布式共识实验的都知道，当节点数量增加到 16 以上时，PBFT 协议的每秒处理交易的量（Transaction Per Second，TPS）会由比较明显的衰退，造成这一现象的主要原因是节点间通信消息的复杂度平方级上涨。但是 HotStuff 中节点数量增加时TPS 的衰减的更加缓慢一些。</p>
<p>HotStuff的第二个优点使得能够频繁的切换主节点，带来的好处是使得整个共识组中每个节点都能拥有排序的权力，这能打破主节点对排序权的垄断。与之相比，PBFT 协议中只有主节点出现故障时共识组才会更换主节点。</p>
<h2 id="关键概念和数据结构"><a class="markdownIt-Anchor" href="#关键概念和数据结构"></a> 关键概念和数据结构</h2>
<h3 id="关键概念"><a class="markdownIt-Anchor" href="#关键概念"></a> 关键概念</h3>
<p>HotStuff 有 3 个版本，分别使 Basic HotStuff、Chained HotStuff 以及 Event-driven HotStuff，下面分别介绍之。在介绍前，需要介绍一些关键概念。</p>
<p>本文将发起提议的节点称之为<strong>主节点</strong>，将其他节点称之为<strong>从节点</strong>，被排序的内容称之为<strong>命令</strong>。</p>
<h3 id="数据结构"><a class="markdownIt-Anchor" href="#数据结构"></a> 数据结构</h3>
<h4 id="node"><a class="markdownIt-Anchor" href="#node"></a> Node</h4>
<p>一个 node 对应一个提议（proposal），主要包含如下两部分内容：</p>
<ul>
<li>parent，它的前一个提议的哈希值。</li>
<li>cmd，该提议包含的命令。</li>
</ul>
<h4 id="qc"><a class="markdownIt-Anchor" href="#qc"></a> QC</h4>
<p><strong>QC</strong> 全称为 quorum certificate，是 HotStuff 中一个重要概念，翻译为足量的证书，QC 主要包含如下数据：</p>
<ul>
<li>type，该 QC 的命令类型。</li>
<li>view Number，视图编号，节点本地的视图用 <strong>CurView</strong> 表示。</li>
<li>node，我更愿意称之为提议，每个 node 包含两个内容：一条来自客户端的命令（cmd）以及它的前一个 proposal 的摘要（digest）。摘要实际上是数据的哈希值。</li>
<li>sig，由（n-f）个节点签名联合组成的一个门限签名，这个签名证明该证书被绝大多数节点认可。</li>
</ul>
<p>QC 的主要目的是作为一个可靠证明，表示当前 QC 中包含的命令以及提议被绝大多数节点接收。因为 QC 中的 sig 有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>−</mo><mi>f</mi></mrow><annotation encoding="application/x-tex">n-f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> 个节点的签名聚合而成，通过验证 QC 中的签名的合法性，就能知道该 QC 对应的提议是否被其他节点接受。</p>
<h4 id="msg"><a class="markdownIt-Anchor" href="#msg"></a> MSG</h4>
<p>主节点向其他节点发送的消息被称之为 MSG，MSG 主要包含如下数据：</p>
<ul>
<li>type，消息类型。</li>
<li>viewNumber，消息对应的视图编号。</li>
<li>node，消息对应的提议。</li>
<li>justify，实际其类型是一个 QC，文中将其称之为 justify。</li>
</ul>
<h4 id="votemsg"><a class="markdownIt-Anchor" href="#votemsg"></a> VoteMSG</h4>
<p>从节点向主节点的 MSG 进行投票时发送的消息，主要包含如下数据：</p>
<ul>
<li>MSG，主节点发送的消息内容本身。</li>
<li>partialSig，从节点对MSG 中 type、viewNumber 和 node 部分签名。</li>
</ul>
<h4 id="curview"><a class="markdownIt-Anchor" href="#curview"></a> curView</h4>
<p>curView 表示每个节点本地的视图，它是一个局部变量，不同的节点之间的视图编号会有所不同。</p>
<h4 id=""><a class="markdownIt-Anchor" href="#"></a> ⊥</h4>
<p>⊥ 符号在 HotStuff 的论文中经常出现，表示空值的含义。</p>
<h2 id="basic-hotstuff"><a class="markdownIt-Anchor" href="#basic-hotstuff"></a> Basic HotStuff</h2>
<p>HotStuff的主要运行过程如下图所示。其中 R0 作为 leader，负责发起共识提议，R1、R2和R3负责投票。</p>
<img src="./image/HotStuff.png" alt="HotStuff" style="zoom:80%;" />
<h3 id="new-veiw"><a class="markdownIt-Anchor" href="#new-veiw"></a> New-Veiw</h3>
<p>HotStuff 中一轮新的共识开始，都是以主节点收集 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>−</mo><mi>f</mi></mrow><annotation encoding="application/x-tex">n-f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> 个 <strong>NEW-VIEW</strong> 消息开始。</p>
<p>共识开始时， R1、R2和R3向新任的主节点发送一个 new-view 消息，<strong>NEW-VIEW</strong> 消息表示其他节点即将过渡到最新的一个视图中。**NEW-VIEW **中包含一个重要的内容，即 <strong>prepared QC</strong>。 prepare QC 是节点在执行共识算法过程中生成的，后续的步骤中读者自会知晓。</p>
<p>当主节点至少收到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>−</mo><mi>f</mi></mrow><annotation encoding="application/x-tex">n-f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> 个 prepare QC 后，从中选择出具有<strong>最高视图编号</strong>的 prepare QC，并以该 prepare QC 中的 node 作为父节点，并在该 node 之后创建一个新的 node，新的 node 中包含一条客户端的命令以及它的父 node 的哈希值。随后主节点将 prepare QC、node 等这些信息生成一条 <strong>PREPARE</strong> 消息中，然后将其广播给其他节点。<strong>PREPARE</strong> 消息的结构如下所示，分别表示消息的类型、视图编号、提议内容和 prepare QC。</p>
<p><strong>MSG= &lt;PREPARE,CurView, NODE, PREPARE QC&gt;</strong></p>
<p>当从节点收到一条 <strong>PREPARE</strong> 消息后，开始进行检查，主要检查如下三项内容：</p>
<ol>
<li>该消息发送自当前视图编号对应的主节点，消息类型为 prepare，并且视图编号正确。</li>
<li>proposal 是 prepare QC 的子节点。</li>
<li><strong>safeNode</strong> 检查，内容如下：
<ol>
<li>proposal 是节点本地 locked QC 的子节点，<strong>安全性规则</strong>。</li>
<li>prepare QC 的视图编号大于 locked QC 的视图编号，<strong>活性规则</strong>。</li>
</ol>
</li>
</ol>
<p>当上述三项检查全部通过时，从节点向主节点发送一条投票消息 （<strong>VoteMSG</strong>）。</p>
<p>与 prepare QC 相同， locked QC  也是节点在执行共识过程中生成的，后续步骤中读者自会知晓。</p>
<h2 id="pre-commit"><a class="markdownIt-Anchor" href="#pre-commit"></a> PRE-COMMIT</h2>
<p>当主节点至少收到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>−</mo><mi>f</mi></mrow><annotation encoding="application/x-tex">n-f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> 个 VoteMSG 时，将这些所有消息的 partialSig 部分进行聚合后形成一个门限签名，以此构建一个 QC，它的 type 为 commit，因而称之为 commit QC，随后主节点构建一个 <strong>PRE-COMMIT</strong> 消息，该消息内容如下：</p>
<p><strong>MSG = &lt;PRE-COMMIT, CurView,NODE = None, commitQC&gt;</strong></p>
<p>主节点将该消息广播给所有节点。</p>
<p>从节点收到该消息后，进行如下检查：</p>
<ol>
<li>该消息发送自当前视图编号对应的主节点，消息类型为 pre-commit，并且视图编号正确。</li>
<li>消息中 QC 的类型为 prepare，并且其视图编号为当前视图编号。</li>
</ol>
<p>当通过上述检查时，从节点本地记录 <strong>prepare QC = MSG.QC</strong>。</p>
<p>此外，从节点还会生成一个 <strong>VoteMsg</strong> 并发送给主节点，其内容如下：</p>
<p><strong>VoteMSG=&lt;MSG, partial sig&gt;</strong></p>
<h3 id="commit"><a class="markdownIt-Anchor" href="#commit"></a> COMMIT</h3>
<p>当主节点收到至少 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>−</mo><mi>f</mi></mrow><annotation encoding="application/x-tex">n-f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> 个 VoteMSG 时，将这些所有消息的 partialSig 部分进行聚合后形成一个门限签名，以此构建一个 QC，它的 type为 pre-commit，因而称之为 precommit QC。随后主节点向从节点广播一条 <strong>COMMIT</strong> 消息，该消息内容如下：</p>
<p><strong>MSG=&lt;COMMIT, CurView, NODE = None, precommit QC&gt;</strong></p>
<p>当从节点收到主节点的 <strong>COMMIT</strong> 消息后，进行如下检查：</p>
<ol>
<li>该消息发送自当前视图编号对应的主节点，消息类型为 commit，并且视图编号正确。</li>
<li>消息中 QC 的类型为 pre-commit，并且其视图编号为当前视图编号。</li>
</ol>
<p>当通过上述检查时，从节点本地记录 <strong>locked QC = MSG.QC</strong>。</p>
<p>此外，从节点还会生成一个 <strong>VoteMsg</strong> 并发送给主节点,其内容如下：</p>
<p><strong>VoteMSG=&lt;MSG, partial sig&gt;</strong></p>
<h3 id="decide"><a class="markdownIt-Anchor" href="#decide"></a> DECIDE</h3>
<p>当主节点收到至少 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>−</mo><mi>f</mi></mrow><annotation encoding="application/x-tex">n-f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> 个 VoteMSG时，将这些所有消息的 partialSig 部分进行聚合后形成一个门限签名，以此构建一个 QC，它的 type 为 commit QC，以内称之为 commit QC。随后主节点向从节点广播一条 <strong>DECIDE</strong> 消息，该消息内容如下：</p>
<p><strong>MSG=&lt;DECIDE, CurView, NODE = None, commit QC&gt;</strong></p>
<p>当从节点收到主节点的 <strong>DECIDE</strong> 消息后，进行如下检查：</p>
<ol>
<li>该消息发送自当前视图编号对应的主节点，消息类型为 decide，并且视图编号正确。</li>
<li>消息中 QC 的类型为 commit，并且其视图编号为当前视图编号。</li>
</ol>
<p>当通过上述检查时，节点开始执行 QC 中对应的 node 的命令。与此同时，节点本地的当前视图编号自增一（<strong>++curView</strong>），随后向下一任主节点发送 <strong>NEW-VIEW</strong> 消息以开启下一轮共识，它的消息内容如下：</p>
<p><strong>MSG=&lt;NEW-VIEW, curView，⊥，prepare QC&gt;</strong></p>
<h2 id="chained-hotstuff"><a class="markdownIt-Anchor" href="#chained-hotstuff"></a> Chained-HotStuff</h2>
<p>可以发现，Basic HotStuff 中主节点在提议阶段主要作用是构建新的提议并选择最新的 QC，其他阶段主要作用是组合新的 QC 并广播给其他节点，那么为什么不令主节点在每个阶段都做出一个新的提议呢？基于这个思路，就产生了链式的 HotStuff，即文中的 Chained-HotStuff。在 Chained-HotStuff 中不再区分每个阶段的 QC ，而是统一称之为 Generic QC。主要运行过程按照角色划分，主要过程如下：</p>
<h4 id="主节点"><a class="markdownIt-Anchor" href="#主节点"></a> 主节点</h4>
<p>根据从节点的投票信息，从中选择出视图编号最大的 QC，在此 QC 之后创建一个新的提议消息并广播给其他节点，消息类型如下：</p>
<p><strong>MSG=&lt;GENERIC, CurView, NODE, GENERIC QC&gt;</strong></p>
<h4 id="从节点"><a class="markdownIt-Anchor" href="#从节点"></a> 从节点</h4>
<p>从节点收到 <strong>GENERIC</strong> 消息之后，检查如下信息：</p>
<ol>
<li>消息类型为 <strong>GENERIC</strong> ，并且其视图编号和本地视图编号一致并且来自于对应的主节点。</li>
<li>使用 SAFENode 规则验证当前提议NODE 和 NODE 的父节点的正确性，如果通过，则向下一个视图的主节点发送投票消息 <strong>VOTEMSG=&lt;MSG, partialSig&gt;</strong>。</li>
<li>沿着其中的链式规则，找到一系列的提议 b-&gt;b’-&gt;b‘’-&gt;b*，进行如下验证和处理：
<ol>
<li>如果 b* 的父节点是 b“，那么记录 prepare QC = b*.justify</li>
<li>如果 b* 的父节点是 b“ 并且 b’‘ 是 b‘ 的父节点，那么记录 locked QC = b’.justify</li>
<li>如果 b* 的父节点是 b“ 并且 b’‘ 是 b‘ 的父节点并且 b 是 b‘ 的父节点，那么执行 b.justify 中的提议，并且向客户端返回执行结果。</li>
</ol>
</li>
</ol>
<h4 id="view-change"><a class="markdownIt-Anchor" href="#view-change"></a> View-Change</h4>
<p>在等待消息期间，如果发生超时，节点本地视图 curView 自增，随后向对应的主节点发送 <strong>NEXT-VIEW</strong> 消息，内容如下：</p>
<p><strong>MSG=&lt;GENERIC, CurView, NODE=none, GENERIC QC&gt;</strong></p>
<h2 id="说明"><a class="markdownIt-Anchor" href="#说明"></a> 说明</h2>
<ol>
<li>每个特定的视图编号下最多确认一个提议。因为当一个提议被确认时视图编号就会加一，当某个视图下没有达成共识时引起超时，此时视图继续增加一。</li>
<li>prepare QC 表示一条命令处于<strong>准备</strong>状态，并且这个准备状态已经被绝大多数节点承认。它的主要作用在发生 view-change 时，令新任的主节点在最新的处于准备状态的命令的基础上进行提议，这样能最大化利用前任主节点的共识工作。但是由于处于准备状态，这条命令也可能会被新任主节点作废。locked QC 表示指令处于<strong>锁定</strong>状态。锁定状态表示该指令已经被锁定为下一个需要执行的指令，它一定会绝大多数节点执行。</li>
</ol>
<h2 id="qa-环节"><a class="markdownIt-Anchor" href="#qa-环节"></a> Q&amp;&amp;A 环节</h2>
<ol>
<li>
<p>为什么 new-view 中使用 prepare QC 作为切换视图的依据，locked QC 可以吗？</p>
<p>locked QC 是完全可以的，因为当一个 node 具有 locked QC 时，那么必然有 prepare QC，因此，使用 locked QC 也可以作为 new-view 中的根据。</p>
</li>
<li>
<p>在切换视图时，为什么使用 prepare QC 而没有使用 locked QC 呢？</p>
<p>使用 prepare QC 能够最大化利用被替换的主节点在共识过程中做的工作。节点本地存储的locked QC 和 prepare QC 有两种可能的情况：</p>
<ol>
<li>locked QC 和 prepare QC 指向同一个提议。</li>
<li>locked QC 指向提议 A，prepare QC 指向提议 B。此时提议 B 必然是提议A 的一个子孙提议，区别是 A已经被共识<strong>锁定</strong>，但是 B 没有被共识<strong>锁定</strong>。如果在 new-view 消息中使用 locked QC，那么新任主节点的新提议会废掉提议 A。实际上，因为 A 已经获得 prepare QC，那么在 B 的基础上继续提议是更好的选择。需要说明的是，实际上，如果主节点执意选择在 locked QC，即  A 处进行新的提议 B‘，其他节点也会接受这一提议，因为新的提议也能通过 safeNode 函数的检查。因为新的提议 B’ 也是绝大多数节点 locked QC（也就是A）的子节点。</li>
</ol>
<p>综上，使用 prepare QC 能够最大化利用前任主节点的共识工作。</p>
</li>
<li>
<p>为什么 HotStuff 中 commit 步骤之后可以达到和 PBFT 中 commit 步骤相同的作用，那么为什么 HotStuff 中还会额外增加 decide 步骤呢？</p>
<p>这一步骤的作用是降低 HotStuff 中 new-view 消息的复杂度，也正是这一步骤，将 HotStuff 中更换主节点的消息复杂度降低到了 O(n) 级别。</p>
<p>假设我们去掉 decide 阶段，并且令节点在 commit 阶段收到主节点的 commit 消息之后，不再继续向主节点发送 commit-vote 消息，而是直接执行该命令。</p>
<p>现在考虑一种场景，假设视图编号为 v 的主节点是拜占庭节点，它将 commit 消息只发送给 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">f-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 个节点，这 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> 个节点（主节点和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">f-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>个节点）更新了 locked QC，并且执行 commit 消息对应的命令。</p>
<p>随后出现超时， HotStuff 中节点向下一任主节点发送 <strong>NEW-VIEW</strong> 消息，每个节点发送最新的 prepare QC，其中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span>个节点发送视图编号为 v 的prepare QC，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>−</mo><mi>f</mi></mrow><annotation encoding="application/x-tex">n-f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> 个节点发送视图编号为 v-1 的 prepare QC。</p>
<p>新任主节点在收到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>−</mo><mi>f</mi></mrow><annotation encoding="application/x-tex">n-f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> 个 new-view 消息后从中选择出 prepare QC 中视图编号最大的一个 QC，随后在这个 QC 后生成新的 proposal，并将其放入 <strong>PREPARE</strong> 消息广播给其他节点。需要注意的是，<strong>PREPARE</strong> 消息只包含主节点挑选的视图编号最大的 QC而并非 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>−</mo><mi>f</mi></mrow><annotation encoding="application/x-tex">n-f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> 个 QC。<strong>PREPARE</strong>消息中的 QC 到底是不是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>−</mo><mi>f</mi></mrow><annotation encoding="application/x-tex">n-f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> 个 new-view 消息中视图编号最大的 QC 是没有办法证明的。</p>
<p>从全局视角看，视图编号最大的 prepare QC 的视图编号为 v，但是主节点可以选择视图编号为 v-1 的一个 prepare QC。此时该主节点在视图编号为 v-1的QC后面提出一个新的提议，然后构建一个 <strong>PREPARE</strong> 消息（该消息的视图编号是 v+1）后广播给其他节点。其中最大prepare QC 的视图编号为 v 的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> 个节点会拒绝投票（safeNode 函数中安全规则无法通过），但是剩余的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>−</mo><mi>f</mi></mrow><annotation encoding="application/x-tex">n-f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> 个最大视图编号为 v-1 的节点会接收这一提议。这就造成不一致，即 HotStuff 更换主节点的方法会导致 commit 阶段执行命令时会出现系统安全性问题。</p>
<p>因此，解决办法有两种（任选其一）：</p>
<ol>
<li>增加一个 decide 阶段，保证一个命令被执行前，绝大多数节点都会锁定该命令，即绝大多数的节点的 locked QC 都是该命令。在 HotStuff 中的 decide 阶段，节点收到 commit QC 时，可以确认绝大多数节点的 locked QC 都是该命令，那么就可以安全的执行该命令,这种方法的弊端是，一条命令的确认时间增加了一个round tripe。</li>
<li>在主节点的 <strong>PREPARE</strong> 中附带上 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>−</mo><mi>f</mi></mrow><annotation encoding="application/x-tex">n-f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> 个 prepare QC 以方便从节点验证主节点挑选出来的视图编号最大的 QC 确实是全局视角下视图编号最大的 QC，但是这种方法带来的弊端就是 <strong>PREPARE</strong> 消息的复杂度直接变为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mi mathvariant="script">n</mi><mn mathvariant="script">2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O(n^2)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 。</li>
</ol>
<p>在 HotStuff 中选择了第一种解决办法，因为命令确认额外增加的时间延迟，可以通过chained-HotStuff 比较好的解决。</p>
</li>
<li>
<p>HotStuff 中的 pacemaker 具体是如何工作的？</p>
</li>
</ol>
<h1 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h1>
<ol>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1803.05069.pdf">HotStuff arxive 论文</a></li>
<li></li>
</ol>
<p>共识协议需要确定的若干个步骤</p>
<ol>
<li>
<p>确定新提议是什么?</p>
</li>
<li>
<p>发现有足够节点确定了新提议后,<strong>预先提交</strong>下一个提议(局部)</p>
</li>
<li>
<p>有足够多的节点<strong>预先提交</strong>了新提议,<strong>正式提交</strong>新提议(局部)</p>
</li>
<li>
<p>有足够多的节点正式提交新提议,确定新协议被确认(全局)</p>
</li>
<li>
<p>L-BFT 协议为什么需要view-change?</p>
<ol>
<li>主节点出现故障时,必须从已有的节点中选择出最新的 主节点以保证共识能够继续。</li>
</ol>
</li>
<li>
<p>view-change 时最新的 leader 应该在哪个状态的基础上再次进行共识？</p>
<ol>
<li>假设通过投票确定最新的 leader，那么应该以投票信息中所有节点的<strong>最新状态</strong>为准，这样能够避免最新 leader 推翻前任 leader 的共识结果。</li>
<li><strong>最新状态</strong>应该是可验证的，例如每个节点投票新 leader 时，将本地最新的 2f+1 个 prepare 消息发送给新的 leader。</li>
</ol>
</li>
<li>
<p>view-change 时需要注意的点</p>
<ol>
<li>view-change 的时候，一定不能回滚已经确认的共识消息。</li>
</ol>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hzxgoforward.github.io/2023/07/02/%E4%B8%BB%E6%B5%81%E7%9A%84%E5%85%AC%E9%93%BE%E4%B8%AD%E7%BD%91%E7%BB%9C%E6%9E%84%E5%BB%BA%E5%92%8C%E6%95%B0%E6%8D%AE%E5%88%86%E5%8F%91%E8%BF%87%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="博主">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuZhenXing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2023/07/02/%E4%B8%BB%E6%B5%81%E7%9A%84%E5%85%AC%E9%93%BE%E4%B8%AD%E7%BD%91%E7%BB%9C%E6%9E%84%E5%BB%BA%E5%92%8C%E6%95%B0%E6%8D%AE%E5%88%86%E5%8F%91%E8%BF%87%E7%A8%8B/" class="post-title-link" itemprop="https://hzxgoforward.github.io/index.html">未命名</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建于：2023-07-02 22:23:12" itemprop="dateCreated datePublished" datetime="2023-07-02T22:23:12+08:00">2023-07-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="更新于：2023-07-03 00:26:03" itemprop="dateModified" datetime="2023-07-03T00:26:03+08:00">2023-07-03</time>
              
            
          </span>

          

          
            
          

          
          

          

          


          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="主流的公链种网络构建和数据分发过程"><a class="markdownIt-Anchor" href="#主流的公链种网络构建和数据分发过程"></a> 主流的公链种网络构建和数据分发过程。</h1>
<p>名称定义</p>
<p><strong>共识节点</strong>：参与共识并生成新区块后扩展区块链的节点，又称之为<strong>验证节点</strong>。</p>
<p><strong>全节点</strong>：不参与共识，但是会跟踪和验证账本数据并存储完整区块链数据的节点。</p>
<h2 id="aptos"><a class="markdownIt-Anchor" href="#aptos"></a> Aptos</h2>
<h2 id="near"><a class="markdownIt-Anchor" href="#near"></a> Near</h2>
<p><a target="_blank" rel="noopener" href="https://near.org/developers">near.org/developers</a></p>
<h2 id="sui"><a class="markdownIt-Anchor" href="#sui"></a> SUI</h2>
<h2 id="节点发现以及入网过程"><a class="markdownIt-Anchor" href="#节点发现以及入网过程"></a> 节点发现以及入网过程</h2>
<p>节点启动时有一个配置文件 fullnode.yaml 文件，该文件中指定节点进入 Testnet 还是 Mainnet。配置文件中还指定了种子节点的信息。例如如果进入主网时种子节点的信息为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">p2p-config:</span><br><span class="line">  seed-peers:</span><br><span class="line">    - address: /dns/icn-00.mainnet.sui.io/udp/8084</span><br><span class="line">      peer-id: 303f1f35afc9a6f82f8d21724f44e1245f4d8eca0806713a07c525dadda95a66</span><br><span class="line">    - address: /dns/icn-01.mainnet.sui.io/udp/8084</span><br><span class="line">      peer-id: cb7ce193cf7a41e9cc2f99e65dd1487b6314a57c74be42cc8c9225b203301812</span><br><span class="line">    - address: /dns/mel-00.mainnet.sui.io/udp/8084</span><br><span class="line">      peer-id: d32b55bdf1737ec415df8c88b3bf91e194b59ee3127e3f38ea46fd88ba2e7849</span><br><span class="line">    - address: /dns/mel-01.mainnet.sui.io/udp/8084</span><br><span class="line">      peer-id: bbf3be337fc16614a1953da83db729abfdc40596e197f36fe408574f7c9b780e</span><br><span class="line">    - address: /dns/ewr-00.mainnet.sui.io/udp/8084</span><br><span class="line">      peer-id: c7bf6cb93ca8fdda655c47ebb85ace28e6931464564332bf63e27e90199c50ee</span><br><span class="line">    - address: /dns/ewr-01.mainnet.sui.io/udp/8084</span><br><span class="line">      peer-id: 3227f8a05f0faa1a197c075d31135a366a1c6f3d4872cb8af66c14dea3e0eb66</span><br><span class="line">    - address: /dns/sjc-00.mainnet.sui.io/udp/8084</span><br><span class="line">      peer-id: 6f0b25087cd6b2fd2e4329bcf308ac95a37c49277dd7286b72470c124809db5b</span><br><span class="line">    - address: /dns/sjc-01.mainnet.sui.io/udp/8084</span><br><span class="line">      peer-id: af1d5d8468b3612ac2b6ff3ca91e99a71390dbe5b83dea9f6ae2da708d689227</span><br><span class="line">    - address: /dns/lhr-00.mainnet.sui.io/udp/8084</span><br><span class="line">      peer-id: c619a5e0f8f36eac45118c1f8bda28f0f508e2839042781f1d4a9818043f732c</span><br><span class="line">    - address: /dns/lhr-01.mainnet.sui.io/udp/8084</span><br><span class="line">      peer-id: 53dcedf250f73b1ec83250614498947db00d17c0181020fcdb7b6db12afbc175</span><br></pre></td></tr></table></figure>
<p>SUI 中全节点入网时，每个从 seed 节点处获取网络中的节点，然后从中随机选择一些节点建立连接，基于这种方式进入网络。</p>
<h3 id="数据同步"><a class="markdownIt-Anchor" href="#数据同步"></a> 数据同步</h3>
<p>文件源码位置：<a target="_blank" rel="noopener" href="https://github.com/MystenLabs/sui/blob/main/crates/sui-network/src/state_sync/mod.rs">sui/crates/sui-network/src/state_sync/mod.rs at main · MystenLabs/sui · GitHub</a></p>
<p>数据类型：checkpoint 、transactions。</p>
<p>当共识层的 validator 产生一个 checkpoint 之后，调用 send_checkpoint 方法将最新状态发送给其他节点。</p>
<p>其他节点收到新的 checkpoint 之后，存储该信息后调用 spawn_notify_peers_of_checkpoint 函数将该信息通知给其他节点。通知的内容为 PeerStateSyncInfo，其结构如下。可以发现其中只包含 checkpoint 的摘要，最低的区块高度和最高的区块高度，但是并不包含 checkpoint 本身。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Copy, Clone, Debug, PartialEq, Eq)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PeerStateSyncInfo</span> &#123;</span><br><span class="line">    <span class="comment">/// The digest of the Peer&#x27;s genesis checkpoint.</span></span><br><span class="line">    genesis_checkpoint_digest: CheckpointDigest,</span><br><span class="line">    <span class="comment">/// Indicates if this Peer is on the same chain as us.</span></span><br><span class="line">    on_same_chain_as_us: <span class="type">bool</span>,</span><br><span class="line">    <span class="comment">/// Highest checkpoint sequence number we know of for this Peer.</span></span><br><span class="line">    height: CheckpointSequenceNumber,</span><br><span class="line">    <span class="comment">/// lowest available checkpoint watermark for this Peer.</span></span><br><span class="line">    <span class="comment">/// This defaults to 0 for now.</span></span><br><span class="line">    lowest: CheckpointSequenceNumber,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当一个节点收到其他节点最新 checkpoint 的消息时，检查其高度是否高于自身，如果高于自身高度，则开启状态同步过程。</p>
<p>此外，每个节点定期与邻居同步最新的 checkpoint 消息，如果发现自身落后，则请求区块。</p>
<h2 id="solana"><a class="markdownIt-Anchor" href="#solana"></a> Solana</h2>
<h3 id="reference-synchronization-solana-docs"><a class="markdownIt-Anchor" href="#reference-synchronization-solana-docs"></a> Reference: <a target="_blank" rel="noopener" href="https://docs.solana.com/cluster/synchronization">Synchronization | Solana Docs</a></h3>
<h1 id=""><a class="markdownIt-Anchor" href="#"></a> </h1>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hzxgoforward.github.io/2023/06/09/Byzantine%20Ordered%20Consensus%20without%20Byzantine%20Oligarchy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="博主">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuZhenXing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2023/06/09/Byzantine%20Ordered%20Consensus%20without%20Byzantine%20Oligarchy/" class="post-title-link" itemprop="https://hzxgoforward.github.io/index.html">未命名</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建于：2023-06-09 18:09:01" itemprop="dateCreated datePublished" datetime="2023-06-09T18:09:01+08:00">2023-06-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="更新于：2023-06-14 19:53:52" itemprop="dateModified" datetime="2023-06-14T19:53:52+08:00">2023-06-14</time>
              
            
          </span>

          

          
            
          

          
          

          

          


          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr />
<h2 id="layout-checkingtitle-byzantine-ordered-consensus-without-byzantine-oligarchydate-2023-6-14-150313tags-共识categories-区块链技术研究"><a class="markdownIt-Anchor" href="#layout-checkingtitle-byzantine-ordered-consensus-without-byzantine-oligarchydate-2023-6-14-150313tags-共识categories-区块链技术研究"></a> layout: checking<br />
title: Byzantine Ordered Consensus without Byzantine Oligarchy<br />
date: 2023-6-14 15:03:13<br />
tags: 共识<br />
categories: 区块链技术研究</h2>
<h1 id="byzantine-ordered-consensus-without-byzantine-oligarchy"><a class="markdownIt-Anchor" href="#byzantine-ordered-consensus-without-byzantine-oligarchy"></a> Byzantine Ordered Consensus without Byzantine Oligarchy</h1>
<p>论文地址: <a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/research/uploads/prod/2020/10/paper-5f89e2898ee53.pdf">OSDI</a></p>
<p><strong>Q1</strong> 论文试图解决什么问题？</p>
<p>In the permissioned blockchains that rely on Byzantine fault tolerant (BFT) SMR, however, nodes have a stake in the specific sequence that ledger records, as well as in preventing other parties from manipulating the sequencing to their advantage. The traditional specification of SMR correctness, however, has no language to express these concerns.<br />
This paper introduces Byzantine ordered consensus, a new primitive that augments the correctness specification of BFT SMR to include specific guarantees on the total orders it produces; and a new architecture for BFT SMR.</p>
<p><strong>Q2</strong> 这是否是一个新的问题？</p>
<p>是。</p>
<p><strong>Q3</strong> 这篇文章要验证一个什么科学假设？</p>
<p><strong>Q4</strong> 有哪些相关研究？如何归类？谁是这一课题在领域内值得关注的研究员？</p>
<p><strong>Q5</strong> 论文中提到的解决方案之关键是什么？</p>
<p><strong>Q6</strong> 论文中的实验是如何设计的？</p>
<p><strong>Q7</strong> 用于定量评估的数据集是什么？代码有没有开源？</p>
<p><strong>Q8</strong> 论文中的实验及结果有没有很好地支持需要验证的科学假设？</p>
<p><strong>Q9</strong> 这篇论文到底有什么贡献？</p>
<p><strong>Q10</strong> 下一步呢？有什么工作可以继续深入？</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hzxgoforward.github.io/2023/04/10/GossipSub_Attack-Resilient%20Message%20Propagation%20in%20the%20Filecoin%20and%20ETH2.0%20Networks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="博主">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuZhenXing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2023/04/10/GossipSub_Attack-Resilient%20Message%20Propagation%20in%20the%20Filecoin%20and%20ETH2.0%20Networks/" class="post-title-link" itemprop="https://hzxgoforward.github.io/index.html">GossipSub-Attack-Resilient Message Propagation in the Filecoin and ETH2.0 Networks</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建于：2023-04-10 18:40:49" itemprop="dateCreated datePublished" datetime="2023-04-10T18:40:49+08:00">2023-04-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="更新于：2023-12-28 22:03:41" itemprop="dateModified" datetime="2023-12-28T22:03:41+08:00">2023-12-28</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91/" itemprop="url" rel="index"><span itemprop="name">网络拓扑</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          


          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="GossipSub-Attack-Resilient-Message-Propagation-in-the-Filecoin-and-ETH2-0-Networks"><a href="#GossipSub-Attack-Resilient-Message-Propagation-in-the-Filecoin-and-ETH2-0-Networks" class="headerlink" title="GossipSub: Attack-Resilient Message Propagation in the Filecoin and ETH2.0 Networks"></a>GossipSub: Attack-Resilient Message Propagation in the Filecoin and ETH2.0 Networks</h1><h2 id="GossipSub-的组成"><a href="#GossipSub-的组成" class="headerlink" title="GossipSub 的组成"></a>GossipSub 的组成</h2><p>在 GossipSub 论文中，它由两部分内容构成：构建网格网络（mesh construction）和评分函数（score function）。其中网格网络主要用于构建快速、资源利用率高、扩展性好的数据传输网络。score function 使得节点拥有抵抗恶意行为的能力。</p>
<h3 id="构建网格"><a href="#构建网格" class="headerlink" title="构建网格"></a>构建网格</h3><p>每个节点都会选择一部分邻居节点并与之构成局部网格（local mesh）。所有节点的局部网格的并集构成了全局网格（global mesh）。当一个节点转发一条消息时，只会将消息转发给至局部网格，接收节点也会将消息继续转发给它的局部网格。需要注意的是，并不是每个节点都需要构建局部网格，因为节点仍然可以通过 gossip 协议请求缺失的数据。</p>
<p>每个节点局部网格节点的数量（也称之为度数） $D$，即该协议的放大因子。局部网格的初始构建根据节点发现机制进行。$D$ 的取值介于 $D<em>{low}$ 和 $D</em>{high}$ 之间。当节点网格的度数超过 $D<em>{high}$ 时，该节点处于过度订阅（over-subscribed）的状态，并且需要在网格中剪除一些节点。当节点网格的度数超过 $D</em>{low}$ 时，该节点处于低订阅（under-subscribed）的状态，需要将新节点加入到网格中。</p>
<p>在将新节点加入网格中时，需要对节点进行筛选，其中 $D_{score}$ 专门用于对每个节点进行排序。</p>
<p>另外一个相关的概念是 $D_{out}$ ，它表示节点主动建立的连接数，这个主要是用于防止节点受到日食攻击。</p>
<h3 id="GossipSub-消息类型"><a href="#GossipSub-消息类型" class="headerlink" title="GossipSub 消息类型"></a>GossipSub 消息类型</h3><ul>
<li>GRAFT：发送方告知接收方被纳入发送方的网格中。</li>
<li>PRUNE：发送方告知接收方被剔除发送方的网格中。</li>
<li>PRUNE-Peer Exchange (PX)：发送方向接收方发送一些网格节点以帮助接收方构建自己的网格。</li>
<li>IHAVE：<strong>gossip</strong> 消息，发送方告知接收方一些可以获取的数据。</li>
<li>IWANT：<strong>gossip</strong> 消息，发送方根据接收方的 IHVAE 消息请求数据。</li>
<li>heartbeat：心跳消息，用于维护 mesh 和 gossip 消息，1 秒 1 次。</li>
</ul>
<p>通过消息类型可知，节点向局部网格发送消息时，直接发送消息内容本身。如果是向非网格节点发送，则会发送 IHAVE 消息。</p>
<h3 id="Gossip-过程"><a href="#Gossip-过程" class="headerlink" title="Gossip 过程"></a>Gossip 过程</h3><p>节点 Gossip 的时候，随机选择一些节点。选择的节点可能是网格节点，也有可能不是。</p>
<p>Gossip 通过心跳发送，节点存储在 1 秒内所有见过的消息，然后通过心跳包发送给其他节点。</p>
<p>当前 GossipSub 中，gossip 的内容通过 3 轮次连续的 heartbeat 消息发出去的。每次 gossip 的时候，只选择一部分节点进行 gossip，经过 3 轮的 gossip使得所有节点都能拿到数据。为什么这么设计？文章后续有交代。</p>
<h3 id="Score-函数"><a href="#Score-函数" class="headerlink" title="Score 函数"></a>Score 函数</h3><script type="math/tex; mode=display">Score(peer) = TC(\sum_{n=1}^{4} w_n(t_i)\times P_n(t_i)) + w_5\times P_5 + w_5 \times 6</script><p>其中 $TC$ 表示 TopicCap，具体概念文中没有做解释。$t_i$ 表示话题权重。下文参数的介绍是基于个人理解，本章中实际上介绍不是很清楚。</p>
<ul>
<li>$P_1$: 网格中的存在时间。</li>
<li>$P_2$:  第一条消息的发送量。</li>
<li>$P_{3a}$: 网格消息发送率，即网格内节点在一定时间窗口内提交的消息量。</li>
<li>$P_{3b}$: 网格消息发送失败率。即网格中节点没有成功发送的消息数量。</li>
<li>$P_4$: 非法消息数，用于惩罚发送非发消息的恶意节点。</li>
<li>$P_5$: 特定应用的分数。</li>
<li>$P_6$: 同一 IP 地址连接的数量，避免女巫攻击。</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hzxgoforward.github.io/2023/04/10/%E5%90%8C%E6%AD%A5%E3%80%81%E5%8D%8A%E5%90%8C%E6%AD%A5%E3%80%81%E5%BC%82%E6%AD%A5%E7%9A%84%E7%90%86%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="博主">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuZhenXing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2023/04/10/%E5%90%8C%E6%AD%A5%E3%80%81%E5%8D%8A%E5%90%8C%E6%AD%A5%E3%80%81%E5%BC%82%E6%AD%A5%E7%9A%84%E7%90%86%E8%A7%A3/" class="post-title-link" itemprop="https://hzxgoforward.github.io/index.html">同步、半同步、异步的概念</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建于：2023-04-10 18:30:19" itemprop="dateCreated datePublished" datetime="2023-04-10T18:30:19+08:00">2023-04-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="更新于：2023-04-28 17:01:41" itemprop="dateModified" datetime="2023-04-28T17:01:41+08:00">2023-04-28</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%85%B1%E8%AF%86%E5%8D%8F%E8%AE%AE/" itemprop="url" rel="index"><span itemprop="name">共识协议</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          


          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="同步-半同步-异步的理解"><a class="markdownIt-Anchor" href="#同步-半同步-异步的理解"></a> 同步、半同步、异步的理解</h1>
<h3 id="同步-半同步-异步定义一"><a class="markdownIt-Anchor" href="#同步-半同步-异步定义一"></a> 同步、半同步、异步定义一</h3>
<ul>
<li>同步是指节点之间的延迟存在一个已知的 Δt 上界</li>
<li>半同步是指节点之间的延迟存在一个 Δt 的上界，但是不知道上界是多少，但是消息一定会传送到。</li>
<li>异步只保证最终消息可达，对传输时间的上限没有假设。</li>
</ul>
<h3 id="同步-半同步-异步定义二"><a class="markdownIt-Anchor" href="#同步-半同步-异步定义二"></a> 同步、半同步、异步定义二</h3>
<ul>
<li><strong>同步（synchronous）网络</strong>假设网络中的消息能够在一个已知的时间 Δ 内到达，这是一种非常理想的假设，实际的工程实践中很难保证这一假设成立。</li>
<li><strong>半同步（partially synchronous）网络</strong>假设在一个 GST（global stabilization time）事件之后，消息在 Δ 时间内到达。随着网络技术的发展，这种假设已经能符合我们生活中遇到多绝大多数网络情况，而且设计和实现这类协议的难度不高，因此很多常见的协议比如 Paxos、Raft、PBFT 等都是基于半同步网络假设设计的共识协议。这些协议虽然能够保证在任何网络情况下系统的一致性，但在异步网络下会丧失活性。</li>
<li><strong>异步（Asynchronous）网络</strong>只保证消息最终能到达，并没有到达时间的限制，这几乎涵盖所有网络情况。由此可见，异步 BFT 协议的鲁棒性最强，即使在极端网络条件下协议也不会丧失活性。</li>
</ul>
<h3 id="比特币为什么是同步协议"><a class="markdownIt-Anchor" href="#比特币为什么是同步协议"></a> 比特币为什么是同步协议</h3>
<p>同步和半同步的区别在于，同步假设下，超过设定的时间，系统安全性会丧失。半同步假设下，超时之后系统安全性不会丧失。</p>
<p>在比特币系统中，如果节点 10 分钟内无法收到新区块，那么整个网络有很大的风险会出现分叉，当网络出现分叉时，系统的安全性已经受到威胁，因此，比特币可以理解为同步协议。</p>
<h3 id="cap-理论"><a class="markdownIt-Anchor" href="#cap-理论"></a> CAP 理论</h3>
<p>一个分布式系统中，Consistency、Availability、Partition tolerance 无法同时获得。</p>
<ul>
<li>一致性（Consistency）：任何事务应该都是原子的，所有副本上的状态都是事务成功提交后的结果，并保持强一致；</li>
<li>可用性（Availability）：系统（非失败节点）能在有限时间内完成对操作请求的应答；</li>
<li>分区容忍性（Partition）：系统中的网络可能发生分区故障（成为多个子网，甚至出现节点上线和下线），即节点之间的通信无法保障。而网络故障不应该影响到系统正常服务。</li>
</ul>
<p>CAP 原理认为，分布式系统最多只能保证三项特性中的两项特性。</p>
<h3 id="flp-不可能原理"><a class="markdownIt-Anchor" href="#flp-不可能原理"></a> FLP 不可能原理</h3>
<p><strong>FLP 不可能原理</strong>：在网络可靠、但允许节点失效（即便只有一个）的最小化异步模型系统中，不存在一个可以解决一致性问题的确定性共识算法（No completely asynchronous consensus protocol can tolerate even a single unannounced process death）。</p>
<h2 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h2>
<p><a target="_blank" rel="noopener" href="https://web.stanford.edu/~ouster/cgi-bin/papers/OngaroPhD.pdf">Consensus: Bridging Theory and Practice (stanford.edu)</a></p>
<p><a target="_blank" rel="noopener" href="https://yeasy.gitbook.io/blockchain_guide/04_distributed_system/flp">FLP 不可能原理 - 区块链技术指南 (gitbook.io)</a></p>
<p>[Synchrony, Asynchrony and Partial synchrony](<a target="_blank" rel="noopener" href="https://decentralizedthoughts.github.io/2019-06-01-2019-5-31-models/">Synchrony, Asynchrony and Partial synchrony (decentralizedthoughts.github.io)</a>)</p>
<p>[共识问题之三：拜占庭容错（BFT）共识算法的发展历程](<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/509757942">共识问题之三：拜占庭容错（BFT）共识算法的发展历程 - 知乎 (zhihu.com)</a>)</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hzxgoforward.github.io/2023/04/10/SSH%20%E8%BF%9C%E7%A8%8B%E7%99%BB%E5%BD%95+%E8%BF%9C%E7%A8%8B%E6%8B%B7%E8%B4%9D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="博主">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuZhenXing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2023/04/10/SSH%20%E8%BF%9C%E7%A8%8B%E7%99%BB%E5%BD%95+%E8%BF%9C%E7%A8%8B%E6%8B%B7%E8%B4%9D/" class="post-title-link" itemprop="https://hzxgoforward.github.io/index.html">ssh 远程登录和拷贝</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建于：2023-04-10 18:30:19 / 更新于：18:37:42" itemprop="dateCreated datePublished" datetime="2023-04-10T18:30:19+08:00">2023-04-10</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/ssh/" itemprop="url" rel="index"><span itemprop="name">ssh</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          


          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ssh-远程登录远程拷贝"><a class="markdownIt-Anchor" href="#ssh-远程登录远程拷贝"></a> SSH 远程登录+远程拷贝</h1>
<p>远程登录方法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh 用户名@ip地址 -p 端口号</span><br></pre></td></tr></table></figure>
<p>例如： ssh <a href="mailto:zxhu@192.168.1.1">zxhu@192.168.1.1</a> -p 22 , 然后输入密码。</p>
<h2 id="将本地的文件拷贝到远程"><a class="markdownIt-Anchor" href="#将本地的文件拷贝到远程"></a> 将本地的文件拷贝到远程：</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -P 22 -r 本地文件路径 用户名@ip地址:远程目录</span><br><span class="line">scp -P 22 -r ./bitcoinSource/ zxhu@192.168.1.1:/home/zxhu</span><br></pre></td></tr></table></figure>
<h2 id="将远程文件拷贝到本地"><a class="markdownIt-Anchor" href="#将远程文件拷贝到本地"></a> 将远程文件拷贝到本地：</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -P 22 -r 用户名@ip地址:远程目录 本地文件路径</span><br><span class="line">scp -P 22 -r zxhu@10.0.0.47:/usr/local/sin.sh ~/tmp/</span><br></pre></td></tr></table></figure>
<p>如果是传输的文件夹，加上-r选项表示递归拷贝，文件夹中内容一起拷贝。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hzxgoforward.github.io/2023/04/10/Rust%E5%AE%9E%E7%8E%B0tcp%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="博主">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuZhenXing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2023/04/10/Rust%E5%AE%9E%E7%8E%B0tcp%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF/" class="post-title-link" itemprop="https://hzxgoforward.github.io/index.html">Rust 实现 tcp 服务器和客户端</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建于：2023-04-10 18:30:19 / 更新于：18:36:29" itemprop="dateCreated datePublished" datetime="2023-04-10T18:30:19+08:00">2023-04-10</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Rust/" itemprop="url" rel="index"><span itemprop="name">Rust</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          


          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="rust-实现-tcp-服务器和客户端"><a class="markdownIt-Anchor" href="#rust-实现-tcp-服务器和客户端"></a> Rust 实现 tcp 服务器和客户端</h1>
<h4 id="服务器端代码如下"><a class="markdownIt-Anchor" href="#服务器端代码如下"></a> 服务器端代码如下：</h4>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">by hzx 2020-08-01</span></span><br><span class="line"><span class="comment">一个简易的echo tcp server实现</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::io::&#123;Error, Read, Write&#125;;</span><br><span class="line"><span class="keyword">use</span> std::net::&#123;Shutdown, TcpListener, TcpStream&#125;;</span><br><span class="line"><span class="keyword">use</span> std::<span class="type">str</span>;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">use</span> std::time;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 该函数处理接入的连接</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">handle_client</span>(<span class="keyword">mut</span> stream: TcpStream) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), Error&gt; &#123;</span><br><span class="line">    <span class="comment">// 512字节的缓冲区读取数据</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = [<span class="number">0</span>; <span class="number">512</span>];</span><br><span class="line">    <span class="comment">// 设置read函数超时时间为60秒</span></span><br><span class="line">    stream</span><br><span class="line">        .<span class="title function_ invoke__">set_read_timeout</span>(<span class="title function_ invoke__">Some</span>(time::Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">60</span> <span class="keyword">as</span> <span class="type">u64</span>)))</span><br><span class="line">        .<span class="title function_ invoke__">expect</span>(<span class="string">&quot;set_read_timeout call failed&quot;</span>);</span><br><span class="line">    <span class="comment">// 获取远程节点的ip地址和端口号</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">addr</span> = stream.<span class="title function_ invoke__">peer_addr</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印远程节点的ip地址和端口号</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;accept a new connection from &#123;&#125;&quot;</span>, addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// loop无限循环，直到read函数超时或者远程客户端关闭连接</span></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 以阻塞模式尝试从stea中接收数据</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">res</span> = stream.<span class="title function_ invoke__">read</span>(&amp;<span class="keyword">mut</span> buf);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// match语句判定读取结果</span></span><br><span class="line">        <span class="keyword">match</span> res &#123;</span><br><span class="line">            <span class="comment">// 读取数据成功</span></span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(bytes_read) =&gt; &#123;</span><br><span class="line">                <span class="comment">// 如果读取数据长度大于0</span></span><br><span class="line">                <span class="keyword">if</span> bytes_read &gt; <span class="number">0</span> &#123;</span><br><span class="line">                    <span class="comment">// 输出远程客户端ip地址、端口号以及接收的数据</span></span><br><span class="line">                    <span class="built_in">println!</span>(</span><br><span class="line">                        <span class="string">&quot;&#123;&#125;: &#123;&#125;&quot;</span>,</span><br><span class="line">                        addr,</span><br><span class="line">                        <span class="type">str</span>::<span class="title function_ invoke__">from_utf8</span>(&amp;buf[..bytes_read])</span><br><span class="line">                            .<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Could not write buffer as string&quot;</span>)</span><br><span class="line">                    );</span><br><span class="line">                    <span class="comment">// echo 服务器将原数据返回</span></span><br><span class="line">                    stream.<span class="title function_ invoke__">write</span>(&amp;buf[..bytes_read])?;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 读取过程出现错误</span></span><br><span class="line">            <span class="title function_ invoke__">Err</span>(e) =&gt; &#123;</span><br><span class="line">                <span class="comment">// 打印错误</span></span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;, error: &#123;:?&#125;&quot;</span>, addr, e);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 跳出loop循环</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 线程休息100毫秒</span></span><br><span class="line">        thread::<span class="title function_ invoke__">sleep</span>(time::Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span> <span class="keyword">as</span> <span class="type">u64</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 关闭连接</span></span><br><span class="line">    stream</span><br><span class="line">        .<span class="title function_ invoke__">shutdown</span>(Shutdown::Both)</span><br><span class="line">        .<span class="title function_ invoke__">expect</span>(<span class="string">&quot;shutdown call failed&quot;</span>);</span><br><span class="line">    <span class="comment">// 返回</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 创建一个TcpListener并绑定至本地8080端口</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">listener</span> = TcpListener::<span class="title function_ invoke__">bind</span>(<span class="string">&quot;127.0.0.1:8080&quot;</span>).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;bind error&quot;</span>);</span><br><span class="line">    <span class="comment">// 创建一个线程Vec管理线程</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">thread_vec</span>: <span class="type">Vec</span>&lt;thread::JoinHandle&lt;()&gt;&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 持续监听</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">stream</span> <span class="keyword">in</span> listener.<span class="title function_ invoke__">incoming</span>() &#123;</span><br><span class="line">        <span class="comment">// 获取监听到的TcpStream，否则报错。</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">stream</span> = stream.<span class="title function_ invoke__">expect</span>(<span class="string">&quot;failed!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个新的线程并返回线程句柄</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="title function_ invoke__">handle_client</span>(stream).<span class="title function_ invoke__">unwrap_or_else</span>(|error| eprintln!(<span class="string">&quot;&#123;:?&#125;&quot;</span>, error));</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 将该线程句柄放入thread_vec中</span></span><br><span class="line">        thread_vec.<span class="title function_ invoke__">push</span>(handle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历thread_vec中所有线程，等待线程执行完毕</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">handle</span> <span class="keyword">in</span> thread_vec &#123;</span><br><span class="line">        handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回结果</span></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr />
<h4 id="客户端代码实现如下"><a class="markdownIt-Anchor" href="#客户端代码实现如下"></a> 客户端代码实现如下：</h4>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">by hzx 2020-08-01</span></span><br><span class="line"><span class="comment">一个简易的echo tcp client 实现</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::io::&#123;<span class="keyword">self</span>, prelude::*, BufReader, Write&#125;;</span><br><span class="line"><span class="keyword">use</span> std::net::&#123;Shutdown, TcpStream&#125;;</span><br><span class="line"><span class="keyword">use</span> std::<span class="type">str</span>;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">use</span> std::time;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 创建TcpStream并尝试与服务器建立连接</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">stream</span> = TcpStream::<span class="title function_ invoke__">connect</span>(<span class="string">&quot;127.0.0.1:8080&quot;</span>)?;</span><br><span class="line">    <span class="comment">// 设置60秒读取数据超时时间</span></span><br><span class="line">    stream</span><br><span class="line">        .<span class="title function_ invoke__">set_read_timeout</span>(<span class="title function_ invoke__">Some</span>(time::Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">60</span> <span class="keyword">as</span> <span class="type">u64</span>)))</span><br><span class="line">        .<span class="title function_ invoke__">expect</span>(<span class="string">&quot;set_read_timeout call failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从标准输入中持续读取数据</span></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="comment">// 新建字符串input</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">input</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 从标准输入中读取数据</span></span><br><span class="line">        io::<span class="title function_ invoke__">stdin</span>()</span><br><span class="line">            .<span class="title function_ invoke__">read_line</span>(&amp;<span class="keyword">mut</span> input)</span><br><span class="line">            .<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Failed to read from stdin&quot;</span>);</span><br><span class="line">        <span class="comment">// 如果input数据为exit，则退出程序</span></span><br><span class="line">        <span class="keyword">if</span> input.<span class="title function_ invoke__">trim</span>() == <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;exit&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 向服务器发送数据</span></span><br><span class="line">        stream</span><br><span class="line">            .<span class="title function_ invoke__">write</span>(input.<span class="title function_ invoke__">as_bytes</span>())</span><br><span class="line">            .<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Failed to write to stream&quot;</span>);</span><br><span class="line">        <span class="comment">// 使用BufReader读取stream中的数据</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">reader</span> = BufReader::<span class="title function_ invoke__">new</span>(&amp;stream);</span><br><span class="line">        <span class="comment">// buffer存储全部数据</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buffer</span>: <span class="type">Vec</span>&lt;<span class="type">u8</span>&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        <span class="comment">// 尝试读取数据</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">res</span> = reader.<span class="title function_ invoke__">read_until</span>(<span class="string">b&#x27;\n&#x27;</span>, &amp;<span class="keyword">mut</span> buffer);</span><br><span class="line">        <span class="comment">// 模式匹配数据</span></span><br><span class="line">        <span class="keyword">match</span> res &#123;</span><br><span class="line">            <span class="comment">// 读取数据成功</span></span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(bytes_read) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> bytes_read &gt; <span class="number">0</span> &#123;</span><br><span class="line">                    <span class="comment">// 输出数据</span></span><br><span class="line">                    <span class="built_in">println!</span>(</span><br><span class="line">                        <span class="string">&quot;echo: &#123;&#125;&quot;</span>,</span><br><span class="line">                        <span class="type">str</span>::<span class="title function_ invoke__">from_utf8</span>(&amp;buffer).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Could not write buffer as string&quot;</span>)</span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 读取数据失败</span></span><br><span class="line">            <span class="title function_ invoke__">Err</span>(e) =&gt; &#123;</span><br><span class="line">                <span class="comment">// 打印错误</span></span><br><span class="line">                eprintln!(<span class="string">&quot;occur error &#123;:?&#125;&quot;</span>, e);</span><br><span class="line">                <span class="comment">// 退出循环</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 睡眠100ms</span></span><br><span class="line">        thread::<span class="title function_ invoke__">sleep</span>(time::Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span> <span class="keyword">as</span> <span class="type">u64</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 输出退出信息</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;we are going to shutdown the connection&quot;</span>);</span><br><span class="line">    <span class="comment">// 关闭连接</span></span><br><span class="line">    stream.<span class="title function_ invoke__">shutdown</span>(Shutdown::Both).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;shutdown error&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hzxgoforward.github.io/2023/04/10/RAFT%20%E5%8D%8F%E8%AE%AE%E7%9A%84%E7%90%86%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="博主">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuZhenXing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2023/04/10/RAFT%20%E5%8D%8F%E8%AE%AE%E7%9A%84%E7%90%86%E8%A7%A3/" class="post-title-link" itemprop="https://hzxgoforward.github.io/index.html">RAFT 共识协议</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建于：2023-04-10 18:30:19 / 更新于：18:35:45" itemprop="dateCreated datePublished" datetime="2023-04-10T18:30:19+08:00">2023-04-10</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%85%AC%E5%BC%8F%E5%8D%8F%E8%AE%AE/" itemprop="url" rel="index"><span itemprop="name">公式协议</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          


          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>相比 PBFT 协议，RAFT 协议是一种容忍CFT(Crash Fault Tolerance)类型的协议，即不考虑节点之间存在作恶的情况。RAFT 协议中主要包括 leader、follower、candidate 三个角色，下面按照协议的运行方式，首先从如何选取 Leader 这一步骤开始讲起。</p>
<h3 id="leader-选择"><a class="markdownIt-Anchor" href="#leader-选择"></a> Leader 选择</h3>
<p>Raft 协议中使用心跳(heartbeat) 的机制触发 leader 选择。当服务器集群启动时，所有的节点都以 follower 的身份启动。当一个节点启动时，首先随机在 150ms~300ms 之间选定一个超时时间，然后等待 leader 发送的 heartbeat。Leader 节点应该定时的向所有的 follower 节点发送 heartbeat 节点以证明自己处于存活状态。如果一个 follower 节点在其超时的时间间隔内还是没有收到 heartbeat，则称之为 election timeout(选举超时)。此时该 follower 假定 leader 可能出错，此时进入 leader 选举阶段。</p>
<p>进入选举阶段，一个 follower 将自己当前的 term(类似于PBFT 协议中的 view) 增加 1，然后切换为 candidate 身份。随后节点向自己投一票，同时向其他 follower 节点发送 RequestVote RPC 以请求它们向该节点投票。在等待其他节点的投票期间，这个节点一只保持自己 candidate 的身份，但是，如果下列三件事情发生，其身份会发生变化：</p>
<ol>
<li>
<p>该节点在本轮投票赢得选举。</p>
</li>
<li>
<p>该节点在本轮选举期间收到来自 leader 的消息。</p>
</li>
<li>
<p>选举超时，没有选出 leader。</p>
</li>
</ol>
<p>一个 candidate 如果能得到大部分节点的选票，那么就能成为 leader。当一个candidate 成为 leader 后，就会立刻向其他 follower 发送 heartbeat 消息以告知自己的 leader 身份以防止其他节点再次进行选举。</p>
<p>节点在向 candidate 投票时，Raft 协议规定在一个 term 只能给一个节点投票，一般按照先来先投票的原则。而成为 leader 的必须收到大多数节点的投票，获得过半票数的设计保证一个 term 最多产生一名 leader。</p>
<p>当一个节点是 candidate 时，如果收到其他节点自称 leader 的消息，则检查消息中的 term，如果leader 的 term 大于等于本节点的 term，则认同发送节点的 leader 身份，并且转至 follower 身份，否则该节点继续保持自己 candidate 的身份。</p>
<p>一个节点可能在一个 term 情况下，没有选举成功，但是也没有选举失败，这是因为多个 candidate 在本次 term 中对票数进行分流。为了解决这个问题，raft 采用随机选举超时的机制，即一个节点如果 candidate 失败之后，再次随机选择一个超时时间，如果这段时间内没有收到新的 leader 的 heartbeat，那么继续保持自己 candidate 身份并继续参加选举。</p>
<h3 id="日志复制log-replication"><a class="markdownIt-Anchor" href="#日志复制log-replication"></a> 日志复制(Log Replication)</h3>
<p>当一个节点成为一个 leader 之后，它便开始处理客户端的 request，每一个 request 都包含一条需要被执行的命令。当 leader 收到一个 request 时，leader 便将该命令当做一个新的 entry 放入到 log 中，随后将这条命令也告知其他 follower。当一个 entry 被安全地复制后，leader 将执行这一条 entry 并且将执行结果反馈给 client。</p>
<p>log 的组织形式如下图所示，log 中的每一个 entry 都包含其对应的 term 、命令以及在 log 中的索引。log 中的 term 用来判检测log 的不一致问题。</p>
<p>leader 用来决策一个 entry 是否要被执行，而一条 entry 被执行前必须首先被 commit。一个 entry 被 commit 的前提是，leader 已经确保这一条 entry 已经被大多数的 follower 收到。当一条 entry 被 commit 之后，这个 entry 之前的所有 entry 也会被 commit。Raft 保证 commit 之后的 entry 是持久化的，并且最终会被所有的状态机执行。</p>
 <img src="image/raft-log.png" alt="image-20220123191025495" style="zoom: 80%;" />
<p>Raft 中如何根据每一条log 的 index 和 term 来确认 log 的一致性呢？其规则如下：</p>
<ul>
<li>如果两个不同 log 中的两个 entry 分别具有相同的 index 和 term，那么这两条 entry 肯定相同。</li>
<li>如果不同两个 log 的两个 entry 具有相同的 index 和 term，那么它们之前的所有 entry 也是相同的。</li>
</ul>
<p>上述第一个规则正确的原因是，对于一个给定的 index，一个 leader 在一个 term 中最多创建一个 entry。</p>
<p>上述第二个规则正确的原因是，每个 leader 发送 log entry 时，每个 entry 都包含其在 leader 的 log 中的 index 和term，follower 将该 entry 放入自己的 log 之后，检查该 entry 的 term 和 index 是否和 leader 的 term 和 index 一致，如果不一致，follower 会拒绝该消息，并且请求重新复制 leader 的 log 。通过这样的措施， follower 的 log 必然可以和 leader 的 log 保持一致。</p>
<p>在 Raft 中，由于网络原因，leader 和 follower 的 log 消息肯定会出现不一致，有可能 leader 的 log 远远多于 follower 的 log ，或者 follower 的 log 比 leader 的还要多。而 Raft 协议中，始终让 follower 复制 leader 的 log 使得 follower 的 log 和 leader 的 log 保持一致，即如果 follower 的 log 和 leader 的log 不一致，那么 follower 的 log 会被重写。</p>
<p>为了维护 log 中的一致性，每个 leader 会为每一个 follower 维护一个变量 nextIndex，这个变量维护了下一次要发送给 follower 的 log 的 index。当一个节点刚刚成为 leader 时，每个 follower 的 nextIndex 会被设置为 leader 节点最后一条日志的后面一个位置。随后 leader 分别向每一个 follower  发送 nextIndex 指向的 log。 如果 follower 收到的 nextIndex 指向的 log 和本地的 log 不同，则 follower 会拒绝该消息，随后 leader 需要在通信过程中发现两者 log 最后一个匹配的位置，随后 follower 才会接受 leader 的 entry。</p>
<h3 id="安全性说明"><a class="markdownIt-Anchor" href="#安全性说明"></a> 安全性说明</h3>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hzxgoforward.github.io/2023/04/10/python%20%E8%8E%B7%E5%8F%96%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84-%E6%96%87%E4%BB%B6%E5%90%8D-%E5%90%8E%E7%BC%80%E5%90%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="博主">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuZhenXing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2023/04/10/python%20%E8%8E%B7%E5%8F%96%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84-%E6%96%87%E4%BB%B6%E5%90%8D-%E5%90%8E%E7%BC%80%E5%90%8D/" class="post-title-link" itemprop="https://hzxgoforward.github.io/index.html">python 获取文件路径-文件名-后缀名</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建于：2023-04-10 18:30:19 / 更新于：18:34:28" itemprop="dateCreated datePublished" datetime="2023-04-10T18:30:19+08:00">2023-04-10</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          


          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="python-获取文件路径-文件名-后缀名"><a class="markdownIt-Anchor" href="#python-获取文件路径-文件名-后缀名"></a> Python 获取文件路径-文件名-后缀名</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">file_dir = <span class="string">&quot;/home2/zxhu/bitcoin-0.19.0_hzx/backup2/2020-07-20_compactBlockValidation.log&quot;</span></span><br><span class="line">file_path, file_name = os.path.split(<span class="built_in">dir</span>)</span><br><span class="line">file_name, extend_name = os.path.splitext(file_name)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>运行结果如下：<br />
<a target="_blank" rel="noopener" href="http://49.232.31.218/wp-content/uploads/2020/07/wp_editor_md_fd245d80135d9b0a8de3cf2733f4d62a.jpg"><img src="http://49.232.31.218/wp-content/uploads/2020/07/wp_editor_md_fd245d80135d9b0a8de3cf2733f4d62a.jpg" alt="" /></a></p>
<h2 id="获取当前路径下目录代码如下"><a class="markdownIt-Anchor" href="#获取当前路径下目录代码如下"></a> 获取当前路径下目录，代码如下：</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.getcwd() <span class="comment">#获取当前工作目录路径</span></span><br><span class="line">os.path.abspath(<span class="string">&#x27;.&#x27;</span>) <span class="comment">#获取当前工作目录路径</span></span><br><span class="line">os.path.abspath(<span class="string">&#x27;test.txt&#x27;</span>) <span class="comment">#获取当前目录文件下的工作目录路径</span></span><br><span class="line">os.path.abspath(<span class="string">&#x27;..&#x27;</span>) <span class="comment">#获取当前工作的父目录 ！注意是父目录路径</span></span><br><span class="line">os.path.abspath(os.curdir) <span class="comment">#获取当前工作目录路径 </span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hzxgoforward.github.io/2023/04/10/Manacher%E7%AE%97%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="博主">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuZhenXing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2023/04/10/Manacher%E7%AE%97%E6%B3%95/" class="post-title-link" itemprop="https://hzxgoforward.github.io/index.html">Manacher(马拉车) 算法</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建于：2023-04-10 18:30:19 / 更新于：18:33:25" itemprop="dateCreated datePublished" datetime="2023-04-10T18:30:19+08:00">2023-04-10</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">算法设计与分析</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          


          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="manacher算法"><a class="markdownIt-Anchor" href="#manacher算法"></a> Manacher算法</h1>
<p>求解一个字符串s中的最长子串，一般的方法是，遍历s中每个字符e，以字符e为回文中心，向两边拓展，求以字符e为回文中心的最长回文串的长度，这样的方法时间复杂度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。鉴于其复杂度，出现了Manacher’s Algorithm，中文名叫马拉车算法，是一位名叫Manacher的人在1975年提出的一种算法。该算法可以在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>时间复杂度内求解一个字符串中的最长回文子串，也可以求解一个字符串中回文子串的总数。</p>
<h2 id="方法"><a class="markdownIt-Anchor" href="#方法"></a> 方法</h2>
<h4 id="1-预处理"><a class="markdownIt-Anchor" href="#1-预处理"></a> 1. 预处理</h4>
<p>由于回文串分为偶回文（比如 bccb）和奇回文（比如 bcacb），处理过程中需要考虑不同的情况，于是Manacher算法对字符串进行了预处理，过程如下：</p>
<ol>
<li>在所有的相邻字符中间插入 #，例如字符串ab，添加#变为 #a#b#。</li>
<li>字符的首尾加入两个不同的字符，例如 ？和 ! , s成为 ?#a#b#!。</li>
</ol>
<p>预处理好处是，如果从#开始拓展回文字符串，那么得到回文子串对应 s 中的偶回文。如果非#的字符开始拓展，找到的回文字符串对应 s 中的奇回文，在处理的过程中不用考虑奇回文还是偶回文的问题，以任意一个字符为回文中心，既可以包含原来的奇数长度的情况，也可以包含原来偶数长度的情况。并且这种处理方式的特点是，对处理后的字符串，以每一个字符为回文中心进行拓展，每次拓展得到的回文数的首尾一定是#，并且其长度是奇数。预处理后可以进入求解过程。</p>
<h4 id="2-求解"><a class="markdownIt-Anchor" href="#2-求解"></a> 2. 求解</h4>
<p>假设原字符串为 s， 预处理后的字符串为<strong>T</strong>。</p>
<ol>
<li>
<p>定义一个辅助数组<strong>f</strong>，f[i]表示<strong>T</strong>中以字符<strong>T[i]<strong>为回文中心的最长回文半径，例如#c#a#c#，以字符a为回文字符串的最长半径为 4。f[i] - 1是</strong>s</strong>中以T[i]为回文中心的最大回文串长度，该问题的证明见推论1及其证明。</p>
</li>
<li>
<p>Manacher 算法依旧需要枚举 <strong>T</strong> 的每一个字符并先假设它是回文中心，但是它会利用已经计算出来的状态来更新$ f(i)<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>。假设我们已经计算好了</mtext></mrow><annotation encoding="application/x-tex">。假设我们已经计算好了</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord cjk_fallback">。</span><span class="mord cjk_fallback">假</span><span class="mord cjk_fallback">设</span><span class="mord cjk_fallback">我</span><span class="mord cjk_fallback">们</span><span class="mord cjk_fallback">已</span><span class="mord cjk_fallback">经</span><span class="mord cjk_fallback">计</span><span class="mord cjk_fallback">算</span><span class="mord cjk_fallback">好</span><span class="mord cjk_fallback">了</span></span></span></span>[1, i-1]$区间内所有点的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span>（即我们知道<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mi>i</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[1, i-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span> 这些点作为回文中心时候的最大半径）， 那么我们求出<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mi>i</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[1, i-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>范围内字符拓展出的最长回文字符串的右端点。</p>
</li>
<li>
<p>例如 i = 4 的时候 f(i) = 5，说明以第 4 个元素为回文中心，最大能拓展到的回文半径是 5，此时对应最长回文字符串的右端点的索引为 4 + 5 - 1 = 8。所以我们可以根据 i以及f(i)时，可以很容易得到它的右端点为$ i + f(i) - 1$。</p>
</li>
<li>
<p>已知<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mi>i</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[1, i-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>范围的 f 求解f(i)时，Manacher 算法要求我们维护<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mi>i</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[1, i-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>范围内每个字符最长回文字符串的右端点的最大值<strong>rm</strong>， 以及该字符串的回文中心<strong>im</strong>。</p>
</li>
<li>
<p>整个过程如下：初始时令 im = 0， rm = 0，遍历<strong>T</strong>中[0, T.size()-1]范围内每个 i ：</p>
<ol>
<li>初始化f(i)
<ol>
<li>如果$ i ≤ rm<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>说明被包含在</mtext><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi>i</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo><mtext>范围内某个字符的最长回文子串中，假设</mtext><mi>j</mi><mtext>是</mtext><mi>i</mi><mtext>这个最大回文字符串回文中心</mtext><mi>i</mi><mi>m</mi><mtext>的对称位置</mtext><mo separator="true">,</mo><mtext>经过</mtext><mi>M</mi><mi>a</mi><mi>n</mi><mi>a</mi><mi>c</mi><mi>h</mi><mi>e</mi><mi>r</mi><mtext>算法处理的最长回文字符串始终是奇数，因此</mtext></mrow><annotation encoding="application/x-tex">说明被包含在[0, i-1]范围内某个字符的最长回文子串中，假设 j 是 i 这个最大回文字符串回文中心 im 的对称位置, 经过Manacher算法处理的最长回文字符串始终是奇数，因此</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord cjk_fallback">说</span><span class="mord cjk_fallback">明</span><span class="mord cjk_fallback">被</span><span class="mord cjk_fallback">包</span><span class="mord cjk_fallback">含</span><span class="mord cjk_fallback">在</span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mord cjk_fallback">范</span><span class="mord cjk_fallback">围</span><span class="mord cjk_fallback">内</span><span class="mord cjk_fallback">某</span><span class="mord cjk_fallback">个</span><span class="mord cjk_fallback">字</span><span class="mord cjk_fallback">符</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">最</span><span class="mord cjk_fallback">长</span><span class="mord cjk_fallback">回</span><span class="mord cjk_fallback">文</span><span class="mord cjk_fallback">子</span><span class="mord cjk_fallback">串</span><span class="mord cjk_fallback">中</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">假</span><span class="mord cjk_fallback">设</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord cjk_fallback">是</span><span class="mord mathnormal">i</span><span class="mord cjk_fallback">这</span><span class="mord cjk_fallback">个</span><span class="mord cjk_fallback">最</span><span class="mord cjk_fallback">大</span><span class="mord cjk_fallback">回</span><span class="mord cjk_fallback">文</span><span class="mord cjk_fallback">字</span><span class="mord cjk_fallback">符</span><span class="mord cjk_fallback">串</span><span class="mord cjk_fallback">回</span><span class="mord cjk_fallback">文</span><span class="mord cjk_fallback">中</span><span class="mord cjk_fallback">心</span><span class="mord mathnormal">i</span><span class="mord mathnormal">m</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">对</span><span class="mord cjk_fallback">称</span><span class="mord cjk_fallback">位</span><span class="mord cjk_fallback">置</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord cjk_fallback">经</span><span class="mord cjk_fallback">过</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord cjk_fallback">算</span><span class="mord cjk_fallback">法</span><span class="mord cjk_fallback">处</span><span class="mord cjk_fallback">理</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">最</span><span class="mord cjk_fallback">长</span><span class="mord cjk_fallback">回</span><span class="mord cjk_fallback">文</span><span class="mord cjk_fallback">字</span><span class="mord cjk_fallback">符</span><span class="mord cjk_fallback">串</span><span class="mord cjk_fallback">始</span><span class="mord cjk_fallback">终</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">奇</span><span class="mord cjk_fallback">数</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">因</span><span class="mord cjk_fallback">此</span></span></span></span> j + i = 2 \times im<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo separator="true">,</mo><mtext>于是我们令</mtext></mrow><annotation encoding="application/x-tex">, 于是我们令</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord cjk_fallback">于</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">我</span><span class="mord cjk_fallback">们</span><span class="mord cjk_fallback">令</span></span></span></span>f(i) = min(f(j), rm-i+1)$,这一步骤为什么取最小值的原因，见推论2及其证明。</li>
<li>初始化 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>=</mo><mn>1</mn><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">f(i) = 1f(i)=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>。</li>
</ol>
</li>
<li>中心拓展
<ol>
<li>做完初始化之后，因为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>+</mo><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">i + f(i)-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 是T[i]字符最长回文字符串的右端点，所以可以保证 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo stretchy="false">[</mo><mi>i</mi><mo>+</mo><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo><mo>=</mo><mi>T</mi><mo stretchy="false">[</mo><mi>i</mi><mo>−</mo><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>+</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">T[i + f(i) - 1] = T[i - f(i) + 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>，要继续拓展这个区间，我们就要继续判断 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo stretchy="false">[</mo><mi>i</mi><mo>+</mo><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">T[i + f(i)]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mclose">]</span></span></span></span>和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo stretchy="false">[</mo><mi>i</mi><mo>−</mo><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">T[i - f(i)]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mclose">]</span></span></span></span> 是否相等，如果相等则将 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span> 自增；这样循环直到 $s[i + f(i)] \neq s[i - f(i)] $。</li>
<li>遍历结束后如果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>+</mo><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>−</mo><mn>1</mn><mo>&gt;</mo><mi>r</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">i + f(i)-1 &gt; rm</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68354em;vertical-align:-0.0391em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">m</span></span></span></span>, 则更新 $ rm = i + f(i)-1, im = i$。</li>
<li>可以看出循环每次结束时都能保证 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo stretchy="false">[</mo><mi>i</mi><mo>+</mo><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo><mo>=</mo><mi>T</mi><mo stretchy="false">[</mo><mi>i</mi><mo>−</mo><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>+</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">T[i + f(i) - 1] = T[i - f(i) + 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>，而循环继续（即可拓展的条件）一定是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo stretchy="false">[</mo><mi>i</mi><mo>+</mo><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo>=</mo><mi>T</mi><mo stretchy="false">[</mo><mi>i</mi><mo>−</mo><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">T[i + f(i)] = T[i - f(i)]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mclose">]</span></span></span></span>。 这个时候需要注意不能让下标越界，但是Manacher方法中在字符串的开头加一个 ?，并在结尾加一个 !，这样开头和结尾的两个字符一定不相等，就可以保证每次<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span>自增的时候不会越界。</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="证明"><a class="markdownIt-Anchor" href="#证明"></a> 证明</h2>
<hr />
<h4 id="推论1"><a class="markdownIt-Anchor" href="#推论1"></a> 推论1</h4>
<ul>
<li>f[i]表示T中以字符T[i]为回文中心的最长回文字符串的半径， f[i] - 1是s中以T[i]为回文中心的最大回文串长度。</li>
</ul>
<h4 id="证明-2"><a class="markdownIt-Anchor" href="#证明-2"></a> 证明</h4>
<p>假设原字符串中，第i个字符最大回文串长度为L，经过马拉车算法处理后的回文字符串长度增加了L+1，总长度为2L+1.已知在处理后的字符串中，第i个字符的最大回文半径为f(i), 则其回文字符串长度为2*f(i)-1 = 2L+1, 由此可知 L = f(i)-1。</p>
<h4 id="推论2"><a class="markdownIt-Anchor" href="#推论2"></a> 推论2</h4>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>=</mo><mi>m</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mi>f</mi><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>r</mi><mi>m</mi><mo>−</mo><mi>i</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i) = min(f(j), rm-i+1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span></li>
</ul>
<h4 id="证明-3"><a class="markdownIt-Anchor" href="#证明-3"></a> 证明</h4>
<pre><code>                                ---X----j---------Im---------i------rm---
</code></pre>
<p>上图中，以im为中心的最长回文字符串的右端端点为rm, 如果i&lt;=rm，说明 i 被包含在im为中心的最长回文字符串中，假设j是最长回文字符串中i在左侧的对称位置，再假设X是最长回文串rm对应的最左端断点，其中X&lt;=j，已知以j为中心的回文字符串长度为f(j), f(i)的初始化分下列两种情况：</p>
<ul>
<li>
<p>case 1： 如下图所示， 如果j的最长回文串的最左侧端点y不在X的左侧(在右侧或者与X重合)，说明y也包含在i的最长回文字符串中，根据i和j的对应关系可知<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>&gt;</mo><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i) &gt;= f(j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>，并且<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mo>=</mo><mi>r</mi><mi>m</mi><mo>−</mo><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">f(j) &lt;= rm -i+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span></span><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>, 因此把f(i)初始化为f(j)。</p>
<pre><code>                            ---X--y--j--y------Im-------y--i--y----rm---
</code></pre>
</li>
<li>
<p>case 2： 如下图所示，如果j为中心的最长回文串的最左侧端点在X左侧，说明y不在i的最长回文字符串中，此时<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>m</mi><mo>−</mo><mi>i</mi><mo>+</mo><mn>1</mn><mo>&lt;</mo><mi>f</mi><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">rm-i+1 &lt; f(j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68354em;vertical-align:-0.0391em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>, 根据i和j的对应关系，我们最多可知<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span> 的长度至少为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>m</mi><mo>−</mo><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">rm -i +1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>,因此把<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span>初始化为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>m</mi><mo>−</mo><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">rm-i+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>。</p>
<pre><code>                               -y--X----j--------Im---------i------rm---
</code></pre>
</li>
</ul>
<p>综合case1 和case2， f(i)的长度最大不应该超过rm-i+1, 因此$f(i) = min(f(j), <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>m</mi><mo>−</mo><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">rm -i +1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>)$;</p>
<h2 id="示例代码"><a class="markdownIt-Anchor" href="#示例代码"></a> 示例代码</h2>
<p>下列代码求解一个给定字符串中回文字符串的总数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">manacher</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        string mlcStr;</span><br><span class="line">        mlcStr.<span class="built_in">reserve</span>(s.<span class="built_in">size</span>()*<span class="number">2</span>+<span class="number">3</span>);</span><br><span class="line">        <span class="comment">// 预处理</span></span><br><span class="line">        mlcStr.<span class="built_in">push_back</span>(<span class="string">&#x27;S&#x27;</span>);</span><br><span class="line">        mlcStr.<span class="built_in">push_back</span>(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">const</span> <span class="keyword">auto</span>&amp; e: s)&#123;</span><br><span class="line">            mlcStr.<span class="built_in">push_back</span>(e);</span><br><span class="line">            mlcStr.<span class="built_in">push_back</span>(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mlcStr.<span class="built_in">push_back</span>(<span class="string">&#x27;!&#x27;</span>);</span><br><span class="line">		<span class="comment">// 定义f，遍历mlcStr并求解,将遍历范围控制在[1, mlcStr.size()-1]，排除了？和！，保证数组不会越界</span></span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">f</span><span class="params">(mlcStr.size(), <span class="number">1</span>)</span></span>;</span><br><span class="line">        <span class="type">int</span> im = <span class="number">0</span>, rm = <span class="number">0</span>, res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; mlcStr.<span class="built_in">size</span>()<span class="number">-1</span>; ++i)&#123;</span><br><span class="line">            <span class="comment">// 初始化f[i]</span></span><br><span class="line">            <span class="keyword">if</span>(i &lt;= rm)</span><br><span class="line">                f[i] = <span class="built_in">min</span>(rm - i + <span class="number">1</span>, f[<span class="number">2</span>*im - i]);</span><br><span class="line">            <span class="comment">// 中心拓展</span></span><br><span class="line">            <span class="keyword">while</span>(mlcStr[i+f[i]] == mlcStr[i-f[i]]) f[i]++;</span><br><span class="line">            <span class="comment">// 更新rm和im</span></span><br><span class="line">            <span class="keyword">if</span>( i + f[i]<span class="number">-1</span> &gt; rm)&#123;</span><br><span class="line">                rm = i+f[i]<span class="number">-1</span>;</span><br><span class="line">                im = i;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 求和</span></span><br><span class="line">            res += f[i]/<span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="复杂度分析"><a class="markdownIt-Anchor" href="#复杂度分析"></a> 复杂度分析</h2>
<p>从实现代码来看，由于有两层循环，看起来貌似是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>级别，但是实际上:</p>
<ul>
<li>
<p>如果每次<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>的值不等于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>m</mi><mo>−</mo><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">rm - i + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>的时候，i的最长回文字符串都无法更新，如果可以更新，根据回文字符串可以推出矛盾，这种情况下rm和im不会更新。</p>
</li>
<li>
<p>如果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo><mo>=</mo><mo>=</mo><mi>r</mi><mi>m</mi><mo>−</mo><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">f(j) == rm - i + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span></span><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，此时以T[i]为回文中心的最长回文字符串有可能更新，而rm只能增大不会减小，rm最多更新T.size()次。</p>
</li>
<li>
<p>假设原来s长度为L，那么预处理后T变为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>L</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2L+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>次(除去头尾添加的字符，因为实际遍历过程中排除了这两个字符)，rm最多更新<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>L</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2L+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>次，于是整个字符串的便利操作和和中心拓展最多为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>L</mi><mo>+</mo><mn>1</mn><mo>+</mo><mn>2</mn><mi>L</mi><mo>+</mo><mn>1</mn><mo>=</mo><mn>4</mn><mi>L</mi><mo>+</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">2L+1+2L+1 = 4L+2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord">4</span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span>次，因此其时间复杂度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>，平均访问次数为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>4</mn><mi>L</mi><mo>+</mo><mn>2</mn><mo stretchy="false">)</mo><mo>÷</mo><mi>L</mi><mo>=</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">(4L+2)\div  L = 4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">4</span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">÷</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">4</span></span></span></span>次。</p>
</li>
<li>
<p>由于使用了额外的空间，其空间复杂度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>。</p>
</li>
<li>
<p>如果想看更加详细的证明，可以<a target="_blank" rel="noopener" href="https://ethsonliu.com/2018/04/manacher.html">参看这里</a>。</p>
</li>
<li>
<p>力扣题目链接：<a target="_blank" rel="noopener" href="https://leetcode-cn.com/problems/palindromic-substrings/">回文子串</a></p>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">&gt;</a>
  </nav>


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar1.jpg"
                alt="博主" />
            
              <p class="site-author-name" itemprop="name">博主</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="https://github.com/hzxGoForward" title="github &rarr; https://github.com/hzxGoForward" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i></a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="https://www.zhihu.com/people/wen-ge-hua-49/activities" title="zhihu &rarr; https://www.zhihu.com/people/wen-ge-hua-49/activities" rel="noopener" target="_blank"><i class="fa fa-fw fa-zhihu"></i></a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="/hzx@pku.edu.cn" title="email &rarr; hzx@pku.edu.cn"><i class="fa fa-fw fa-envelope"></i></a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="https://me.csdn.net/t46414704152abc/" title="csdn &rarr; https://me.csdn.net/t46414704152abc/" rel="noopener" target="_blank"><i class="fa fa-fw fa-csdn"></i></a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="https://leetcode.cn/u/hzxforward/" title="leetcode &rarr; https://leetcode.cn/u/hzxforward/" rel="noopener" target="_blank"><i class="fa fa-fw fa-leetcode"></i></a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </section>

      

      

<!--背景音乐-->
<!--iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=86 src="//music.163.com/outchain/player?type=2&id=37856454&auto=1&height=66"></iframe> --> 
<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=556319523&auto=1&height=66"></iframe> -->
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=86 src="//music.163.com/outchain/player?type=2&id=4341314&auto=1&height=66"></iframe>

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">博主</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v6.3.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v6.6.0</div>


<div>
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!--注释本行<span id="busuanzi_container_site_pv" style='display:none'>-->
    本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
    <span class="post-meta-divider">|</span>
</span>
<span id="busuanzi_container_site_uv" style='display:none'>
    本站访问<span id="busuanzi_value_site_uv"></span>人次
</span>
</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="Total Visitors">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="Total Views">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
      
  
  <script type="text/javascript" color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.6.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.6.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.6.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.6.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  










  





  

  

  

  



  
  

  
  
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  

  


  
  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('Copy')
        }, 300)
      }).append(e)
    })
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


  

</body>
</html>
