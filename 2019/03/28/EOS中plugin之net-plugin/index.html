<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.6.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.6.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '6.6.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="这部分重点介绍EOS中的服务器端部分nodeos启动之后开启的另外一个重要的插件——net_plugin，这个插件主要负责服务器在网络中的接入、同步区块信息、断开等功能。对于这个插件，首先从其类的定义开始了解。 123456789101112131415161718192021222324class net_plugin : public appbase::plugin&lt;net_plugin">
<meta property="og:type" content="article">
<meta property="og:title" content="EOS中plugin之net_plugin">
<meta property="og:url" content="https://hzxgoforward.github.io/2019/03/28/EOS%E4%B8%ADplugin%E4%B9%8Bnet-plugin/index.html">
<meta property="og:site_name" content="hzx&#39;s Home">
<meta property="og:description" content="这部分重点介绍EOS中的服务器端部分nodeos启动之后开启的另外一个重要的插件——net_plugin，这个插件主要负责服务器在网络中的接入、同步区块信息、断开等功能。对于这个插件，首先从其类的定义开始了解。 123456789101112131415161718192021222324class net_plugin : public appbase::plugin&lt;net_plugin">
<meta property="og:locale">
<meta property="article:published_time" content="2019-03-28T06:15:24.000Z">
<meta property="article:modified_time" content="2019-11-08T06:58:43.000Z">
<meta property="article:author" content="hzx">
<meta name="twitter:card" content="summary">






  <link rel="canonical" href="https://hzxgoforward.github.io/2019/03/28/EOS中plugin之net-plugin/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>EOS中plugin之net_plugin | hzx's Home</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">hzx's Home</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Hello World!</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hzxgoforward.github.io/2019/03/28/EOS%E4%B8%ADplugin%E4%B9%8Bnet-plugin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="博主">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar2.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hzx's Home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">EOS中plugin之net_plugin
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建于：2019-03-28 14:15:24" itemprop="dateCreated datePublished" datetime="2019-03-28T14:15:24+08:00">2019-03-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="更新于：2019-11-08 14:58:43" itemprop="dateModified" datetime="2019-11-08T14:58:43+08:00">2019-11-08</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF%E7%A0%94%E7%A9%B6/" itemprop="url" rel="index"><span itemprop="name">区块链技术研究</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <span class="post-meta-divider">|</span>
            <span id="busuanzi_value_page_pv"></span>次阅读
          


          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>这部分重点介绍EOS中的服务器端部分nodeos启动之后开启的另外一个重要的插件——net_plugin，这个插件主要负责服务器在网络中的接入、同步区块信息、断开等功能。对于这个插件，首先从其类的定义开始了解。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">net_plugin</span> : <span class="keyword">public</span> appbase::plugin&lt;net_plugin&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">net_plugin</span>();</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">net_plugin</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">APPBASE_PLUGIN_REQUIRES</span>((chain_plugin))    <span class="comment">// net_plugin这个插件的启动，依赖chain_plugin插件</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">set_program_options</span><span class="params">(options_description&amp; cli, options_description&amp; cfg)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">plugin_initialize</span><span class="params">(<span class="type">const</span> variables_map&amp; options)</span></span>;  <span class="comment">// 插件初始化</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">plugin_startup</span><span class="params">()</span></span>;                                 <span class="comment">// 插件的启动</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">plugin_shutdown</span><span class="params">()</span></span>;                                <span class="comment">// 插件关闭</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span>   <span class="title">broadcast_block</span><span class="params">(<span class="type">const</span> chain::signed_block &amp;sb)</span></span>; <span class="comment">// 广播区块</span></span><br><span class="line"></span><br><span class="line">    <span class="function">string                       <span class="title">connect</span><span class="params">( <span class="type">const</span> string&amp; endpoint )</span></span>; <span class="comment">// 连接其他端点</span></span><br><span class="line">    <span class="function">string                       <span class="title">disconnect</span><span class="params">( <span class="type">const</span> string&amp; endpoint )</span></span>; <span class="comment">// 断开连接</span></span><br><span class="line">    <span class="function">optional&lt;connection_status&gt;  <span class="title">status</span><span class="params">( <span class="type">const</span> string&amp; endpoint )</span><span class="type">const</span></span>;   <span class="comment">// 查看与某个端点的链接状态</span></span><br><span class="line">    <span class="function">vector&lt;connection_status&gt;    <span class="title">connections</span><span class="params">()</span><span class="type">const</span></span>;                   <span class="comment">// 查看连接状态</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">num_peers</span><span class="params">()</span> <span class="type">const</span></span>;                                          <span class="comment">// 查看建立连接的端点个数</span></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">    std::unique_ptr&lt;<span class="keyword">class</span> <span class="title class_">net_plugin_impl</span>&gt; my;   <span class="comment">// 和producer_plugin_imple一样，这个插件负责网络中的具体操作</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>net_plugin插件的代码还是比较容易理解的，net_plugin的初始化函数非常简单，代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">net_plugin::<span class="built_in">net_plugin</span>()</span><br><span class="line">    :<span class="built_in">my</span>( <span class="keyword">new</span> net_plugin_impl ) &#123;</span><br><span class="line">    my_impl = my.<span class="built_in">get</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化函数中生成了一阁net_plugin_impl的实例，随后将my的指针赋值给了net_plugin_impl类中的定义的静态指针,这个静态指针的定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> net_plugin_impl *my_impl;</span><br></pre></td></tr></table></figure>
<p>再nodeos的main函数中，net_plugin首先会初始化，随后调用其plugin_initialize函数和<a href="https://hzxgoforward.github.io/2019/03/20/EOS%E4%B8%ADplugin%E7%9A%84%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84/">EOS中lugin之producer_plugin</a>的介绍的procuder_plugin类初始化方式时一样的，先寻找这个插件依赖的插件，然后初始化依赖的插件、一些启动参数，设置心跳计时器等。</p>
<p>nodeos中初始化完毕，随后调用net_plugin的plugin_startup函数，该函数代码如下:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">net_plugin::plugin_startup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    my-&gt;producer_plug = <span class="built_in">app</span>().<span class="built_in">find_plugin</span>&lt;producer_plugin&gt;();</span><br><span class="line">    <span class="keyword">if</span>( my-&gt;acceptor ) &#123;</span><br><span class="line">        <span class="comment">// 常见的网络服务操作,打开监听服务,设置选项,绑定地址,启动监听</span></span><br><span class="line">        my-&gt;acceptor-&gt;<span class="built_in">open</span>(my-&gt;listen_endpoint.<span class="built_in">protocol</span>());</span><br><span class="line">        my-&gt;acceptor-&gt;<span class="built_in">set_option</span>(tcp::acceptor::<span class="built_in">reuse_address</span>(<span class="literal">true</span>));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// acceptor 来自于boost::asio::ip::tcp，即tcp::acceptor</span></span><br><span class="line">        my-&gt;acceptor-&gt;<span class="built_in">bind</span>(my-&gt;listen_endpoint);</span><br><span class="line">        &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;</span><br><span class="line">        <span class="built_in">ilog</span>(<span class="string">&quot;net_plugin::plugin_startup failed to bind to port $&#123;port&#125;&quot;</span>,</span><br><span class="line">            (<span class="string">&quot;port&quot;</span>, my-&gt;listen_endpoint.<span class="built_in">port</span>()));</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        my-&gt;acceptor-&gt;<span class="built_in">listen</span>();</span><br><span class="line">        <span class="built_in">ilog</span>(<span class="string">&quot;starting listener, max clients is $&#123;mc&#125;&quot;</span>,(<span class="string">&quot;mc&quot;</span>,my-&gt;max_client_count));</span><br><span class="line">        my-&gt;<span class="built_in">start_listen_loop</span>();   <span class="comment">// 循环监听函数</span></span><br><span class="line">    &#125;</span><br><span class="line">    chain::controller&amp;cc = my-&gt;chain_plug-&gt;<span class="built_in">chain</span>();</span><br><span class="line">    &#123;</span><br><span class="line">        cc.accepted_block.<span class="built_in">connect</span>(  boost::<span class="built_in">bind</span>(&amp;net_plugin_impl::accepted_block, my.<span class="built_in">get</span>(), _1));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    my-&gt;incoming_transaction_ack_subscription = <span class="built_in">app</span>().<span class="built_in">get_channel</span>&lt;channels::transaction_ack&gt;().<span class="built_in">subscribe</span>(boost::<span class="built_in">bind</span>(&amp;net_plugin_impl::transaction_ack, my.<span class="built_in">get</span>(), _1));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( cc.<span class="built_in">get_read_mode</span>() == chain::db_read_mode::READ_ONLY ) &#123;</span><br><span class="line">        my-&gt;max_nodes_per_host = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">ilog</span>( <span class="string">&quot;node in read-only mode setting max_nodes_per_host to 0 to prevent connections&quot;</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 启动连接和交易到期的监视</span></span><br><span class="line">    my-&gt;<span class="built_in">start_monitors</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">auto</span> seed_node : my-&gt;supplied_peers ) &#123;</span><br><span class="line">        <span class="built_in">connect</span>( seed_node );<span class="comment">// 连接种子节点,接入p2p网络</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fc::<span class="built_in">get_logger_map</span>().<span class="built_in">find</span>(logger_name) != fc::<span class="built_in">get_logger_map</span>().<span class="built_in">end</span>())</span><br><span class="line">        logger = fc::<span class="built_in">get_logger_map</span>()[logger_name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先打开监听的端口号，设置相关协议，随后绑定端口号，然后开始监听网络中的信息，同时让本端点连接到网络中的种子节点，以此连接EOS中的p2p网络。这里面最重要的2个函数是 my-&gt;start_listen_loop()以及my-&gt;start_monitors()函数,my-&gt;start_listen_loop，通过函数名称可以断定主要用来不断地从网络中监听网络中发送的信息，my-&gt;start_monitors()应该是进行监听，但是到底监听什么，我们还不得而知。</p>
<p>这里暂时先不对net_plugin_impl进行具体解析，因为这并不影响我们对这两个函数的分析，另外一方面，net_plugin_impl的介绍对于这两个函数的分析，帮助不大。<br />
因此，我们直接进入start_listen_loop函数一探究竟。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 该函数循环监听信息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">net_plugin_impl::start_listen_loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> socket = std::<span class="built_in">make_shared</span>&lt;tcp::socket&gt;( std::<span class="built_in">ref</span>( <span class="built_in">app</span>().<span class="built_in">get_io_service</span>() ) );</span><br><span class="line">    acceptor-&gt;<span class="built_in">async_accept</span>( *socket, [socket,<span class="keyword">this</span>]( boost::system::error_code ec ) &#123;</span><br><span class="line">        <span class="keyword">if</span>( !ec ) &#123;</span><br><span class="line">            <span class="type">uint32_t</span> visitors = <span class="number">0</span>;</span><br><span class="line">            <span class="type">uint32_t</span> from_addr = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">auto</span> paddr = socket-&gt;<span class="built_in">remote_endpoint</span>(ec).<span class="built_in">address</span>();</span><br><span class="line">            <span class="keyword">if</span> (ec) &#123;</span><br><span class="line">                <span class="built_in">fc_elog</span>(logger,<span class="string">&quot;Error getting remote endpoint: $&#123;m&#125;&quot;</span>,(<span class="string">&quot;m&quot;</span>, ec.<span class="built_in">message</span>()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;conn : connections) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(conn-&gt;socket-&gt;<span class="built_in">is_open</span>()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (conn-&gt;peer_addr.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                        visitors++;</span><br><span class="line">                        boost::system::error_code ec;</span><br><span class="line">                        <span class="keyword">if</span> (paddr == conn-&gt;socket-&gt;<span class="built_in">remote_endpoint</span>(ec).<span class="built_in">address</span>()) &#123;</span><br><span class="line">                            from_addr++;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (num_clients != visitors) &#123;</span><br><span class="line">                    <span class="built_in">ilog</span>(<span class="string">&quot;checking max client, visitors = $&#123;v&#125; num clients $&#123;n&#125;&quot;</span>,(<span class="string">&quot;v&quot;</span>,visitors)(<span class="string">&quot;n&quot;</span>,num_clients));</span><br><span class="line">                    num_clients = visitors;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>( from_addr &lt; max_nodes_per_host &amp;&amp; (max_client_count == <span class="number">0</span> || num_clients &lt; max_client_count )) &#123;</span><br><span class="line">                    ++num_clients;</span><br><span class="line">                    connection_ptr c = std::<span class="built_in">make_shared</span>&lt;connection&gt;( socket );</span><br><span class="line">                    connections.<span class="built_in">insert</span>( c );</span><br><span class="line">                    <span class="built_in">start_session</span>( c );</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (from_addr &gt;= max_nodes_per_host) &#123;</span><br><span class="line">                    <span class="built_in">fc_elog</span>(logger, <span class="string">&quot;Number of connections ($&#123;n&#125;) from $&#123;ra&#125; exceeds limit&quot;</span>,</span><br><span class="line">                            (<span class="string">&quot;n&quot;</span>, from_addr+<span class="number">1</span>)(<span class="string">&quot;ra&quot;</span>,paddr.<span class="built_in">to_string</span>()));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">fc_elog</span>(logger, <span class="string">&quot;Error max_client_count $&#123;m&#125; exceeded&quot;</span>,</span><br><span class="line">                            ( <span class="string">&quot;m&quot;</span>, max_client_count) );</span><br><span class="line">                    &#125;</span><br><span class="line">                    socket-&gt;<span class="built_in">close</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">elog</span>( <span class="string">&quot;Error accepting connection: $&#123;m&#125;&quot;</span>,( <span class="string">&quot;m&quot;</span>, ec.<span class="built_in">message</span>() ) );</span><br><span class="line">            <span class="comment">// For the listed error codes below, recall start_listen_loop()</span></span><br><span class="line">            <span class="keyword">switch</span> (ec.<span class="built_in">value</span>()) &#123;</span><br><span class="line">                <span class="keyword">case</span> ECONNABORTED:</span><br><span class="line">                <span class="keyword">case</span> EMFILE:</span><br><span class="line">                <span class="keyword">case</span> ENFILE:</span><br><span class="line">                <span class="keyword">case</span> ENOBUFS:</span><br><span class="line">                <span class="keyword">case</span> ENOMEM:</span><br><span class="line">                <span class="keyword">case</span> EPROTO:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">start_listen_loop</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>start_listen_loop()函数中最重要的一个函数是，监听到消息之后的start_session()函数，表示监听到了新的链接，于是开始会话。start_session()函数内容如下所示。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">net_plugin_impl::start_session</span><span class="params">(<span class="type">const</span> connection_ptr&amp; con)</span> </span>&#123;</span><br><span class="line">    boost::asio::ip::<span class="function">tcp::no_delay <span class="title">nodelay</span><span class="params">( <span class="literal">true</span> )</span></span>;</span><br><span class="line">    boost::system::error_code ec;</span><br><span class="line">    con-&gt;socket-&gt;<span class="built_in">set_option</span>( nodelay, ec );</span><br><span class="line">    <span class="keyword">if</span> (ec) &#123;</span><br><span class="line">        <span class="comment">// 如果接受数据出错， 直接关闭连接，写日志</span></span><br><span class="line">        <span class="built_in">elog</span>( <span class="string">&quot;connection failed to $&#123;peer&#125;: $&#123;error&#125;&quot;</span>,</span><br><span class="line">            ( <span class="string">&quot;peer&quot;</span>, con-&gt;<span class="built_in">peer_name</span>())(<span class="string">&quot;error&quot;</span>,ec.<span class="built_in">message</span>()));</span><br><span class="line">        con-&gt;connecting = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">close</span>(con);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 读取数据，已经开启的session+1</span></span><br><span class="line">        <span class="built_in">start_read_message</span>( con );</span><br><span class="line">        ++started_sessions;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// for now, we can just use the application main loop.</span></span><br><span class="line">        <span class="comment">//     con-&gt;readloop_complete  = bf::async( [=]()&#123; read_loop( con ); &#125; );</span></span><br><span class="line">        <span class="comment">//     con-&gt;writeloop_complete = bf::async( [=]()&#123; write_loop con ); &#125; );</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中重要的是start_read_message，即回话过程中读取数据，即start_read_message()函数，其具体内容如下所示。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">net_plugin_impl::start_read_message</span><span class="params">(<span class="type">const</span> connection_ptr&amp; conn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(!conn-&gt;socket) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        connection_wptr weak_conn = conn;</span><br><span class="line"></span><br><span class="line">        std::<span class="type">size_t</span> minimum_read = conn-&gt;outstanding_read_bytes ? *conn-&gt;outstanding_read_bytes : message_header_size;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 默认为false，在plugin_initialized中使用</span></span><br><span class="line">        <span class="keyword">if</span> (use_socket_read_watermark) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">size_t</span> max_socket_read_watermark = <span class="number">4096</span>;</span><br><span class="line">        std::<span class="type">size_t</span> socket_read_watermark = std::<span class="built_in">min</span>&lt;std::<span class="type">size_t</span>&gt;(minimum_read, max_socket_read_watermark);</span><br><span class="line">        boost::asio::<span class="function">socket_base::receive_low_watermark <span class="title">read_watermark_opt</span><span class="params">(socket_read_watermark)</span></span>;</span><br><span class="line">        conn-&gt;socket-&gt;<span class="built_in">set_option</span>(read_watermark_opt);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> completion_handler = [minimum_read](boost::system::error_code ec, std::<span class="type">size_t</span> bytes_transferred) -&gt; std::<span class="type">size_t</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ec || bytes_transferred &gt;= minimum_read ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> minimum_read - bytes_transferred;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从stream中异步读取固定大小的数据</span></span><br><span class="line">        <span class="comment">/* async_read(AsyncReadStream &amp;S, const MutableBufferSequence&amp; buffers, ReadHandler&amp;&amp; handler, )</span></span><br><span class="line"><span class="comment">        从*conn-&gt;socket中读取data，读到buffers中去，buffers的大小告诉系统读取多少</span></span><br><span class="line"><span class="comment">        handler是读取数据完毕之后调用的函数 */</span></span><br><span class="line">        boost::asio::<span class="built_in">async_read</span>(*conn-&gt;socket,</span><br><span class="line">        conn-&gt;pending_message_buffer.<span class="built_in">get_buffer_sequence_for_boost_async_read</span>(), </span><br><span class="line">        completion_handler,</span><br><span class="line">        [<span class="keyword">this</span>,weak_conn]( boost::system::error_code ec, std::<span class="type">size_t</span> bytes_transferred ) &#123;</span><br><span class="line">            <span class="keyword">auto</span> conn = weak_conn.<span class="built_in">lock</span>();</span><br><span class="line">            <span class="keyword">if</span> (!conn) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            conn-&gt;outstanding_read_bytes.<span class="built_in">reset</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>( !ec ) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (bytes_transferred &gt; conn-&gt;pending_message_buffer.<span class="built_in">bytes_to_write</span>()) &#123;</span><br><span class="line">                    <span class="built_in">elog</span>(<span class="string">&quot;async_read_some callback: bytes_transfered = $&#123;bt&#125;, buffer.bytes_to_write = $&#123;btw&#125;&quot;</span>,</span><br><span class="line">                            (<span class="string">&quot;bt&quot;</span>,bytes_transferred)(<span class="string">&quot;btw&quot;</span>,conn-&gt;pending_message_buffer.<span class="built_in">bytes_to_write</span>()));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in">EOS_ASSERT</span>(bytes_transferred &lt;= conn-&gt;pending_message_buffer.<span class="built_in">bytes_to_write</span>(), plugin_exception, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                    conn-&gt;pending_message_buffer.<span class="built_in">advance_write_ptr</span>(bytes_transferred);</span><br><span class="line">                    <span class="keyword">while</span> (conn-&gt;pending_message_buffer.<span class="built_in">bytes_to_read</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="type">uint32_t</span> bytes_in_buffer = conn-&gt;pending_message_buffer.<span class="built_in">bytes_to_read</span>();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (bytes_in_buffer &lt; message_header_size) &#123;</span><br><span class="line">                        conn-&gt;outstanding_read_bytes.<span class="built_in">emplace</span>(message_header_size - bytes_in_buffer);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="type">uint32_t</span> message_length;</span><br><span class="line">                        <span class="keyword">auto</span> index = conn-&gt;pending_message_buffer.<span class="built_in">read_index</span>();</span><br><span class="line">                        conn-&gt;pending_message_buffer.<span class="built_in">peek</span>(&amp;message_length, <span class="built_in">sizeof</span>(message_length), index);</span><br><span class="line">                        <span class="keyword">if</span>(message_length &gt; def_send_buffer_size*<span class="number">2</span> || message_length == <span class="number">0</span>) &#123;</span><br><span class="line">                            boost::system::error_code ec;</span><br><span class="line">                            <span class="built_in">elog</span>(<span class="string">&quot;incoming message length unexpected ($&#123;i&#125;), from $&#123;p&#125;&quot;</span>,</span><br><span class="line">                                (<span class="string">&quot;i&quot;</span>, message_length)(<span class="string">&quot;p&quot;</span>,boost::<span class="built_in">lexical_cast</span>&lt;std::string&gt;(conn-&gt;socket-&gt;<span class="built_in">remote_endpoint</span>(ec))));</span><br><span class="line">                            <span class="built_in">close</span>(conn);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">auto</span> total_message_bytes = message_length + message_header_size;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (bytes_in_buffer &gt;= total_message_bytes) &#123;</span><br><span class="line">                            conn-&gt;pending_message_buffer.<span class="built_in">advance_read_ptr</span>(message_header_size);</span><br><span class="line">                            <span class="comment">// 这一部分是网络通信的内容，对于其中细节不甚了解</span></span><br><span class="line">                            <span class="comment">// 接收的数据传递到pending_message_buffer中，</span></span><br><span class="line">                            <span class="comment">// process_next_message中进行处理从pending_message_buffer中处理数据</span></span><br><span class="line">                            <span class="keyword">if</span> (!conn-&gt;<span class="built_in">process_next_message</span>(*<span class="keyword">this</span>, message_length)) &#123;</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">auto</span> outstanding_message_bytes = total_message_bytes - bytes_in_buffer;</span><br><span class="line">                            <span class="keyword">auto</span> available_buffer_bytes = conn-&gt;pending_message_buffer.<span class="built_in">bytes_to_write</span>();</span><br><span class="line">                            <span class="keyword">if</span> (outstanding_message_bytes &gt; available_buffer_bytes) &#123;</span><br><span class="line">                                conn-&gt;pending_message_buffer.<span class="built_in">add_space</span>( outstanding_message_bytes - available_buffer_bytes );</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            conn-&gt;outstanding_read_bytes.<span class="built_in">emplace</span>(outstanding_message_bytes);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in">start_read_message</span>(conn);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">auto</span> pname = conn-&gt;<span class="built_in">peer_name</span>();</span><br><span class="line">                    <span class="keyword">if</span> (ec.<span class="built_in">value</span>() != boost::asio::error::eof) &#123;</span><br><span class="line">                    <span class="built_in">elog</span>( <span class="string">&quot;Error reading message from $&#123;p&#125;: $&#123;m&#125;&quot;</span>,(<span class="string">&quot;p&quot;</span>,pname)( <span class="string">&quot;m&quot;</span>, ec.<span class="built_in">message</span>() ) );</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">ilog</span>( <span class="string">&quot;Peer $&#123;p&#125; closed connection&quot;</span>,(<span class="string">&quot;p&quot;</span>,pname) );</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in">close</span>( conn );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">catch</span>(<span class="type">const</span> std::exception &amp;ex) &#123;</span><br><span class="line">                string pname = conn ? conn-&gt;<span class="built_in">peer_name</span>() : <span class="string">&quot;no connection name&quot;</span>;</span><br><span class="line">                <span class="built_in">elog</span>(<span class="string">&quot;Exception in handling read data from $&#123;p&#125; $&#123;s&#125;&quot;</span>,(<span class="string">&quot;p&quot;</span>,pname)(<span class="string">&quot;s&quot;</span>,ex.<span class="built_in">what</span>()));</span><br><span class="line">                <span class="built_in">close</span>( conn );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">catch</span>(<span class="type">const</span> fc::exception &amp;ex) &#123;</span><br><span class="line">                string pname = conn ? conn-&gt;<span class="built_in">peer_name</span>() : <span class="string">&quot;no connection name&quot;</span>;</span><br><span class="line">                <span class="built_in">elog</span>(<span class="string">&quot;Exception in handling read data $&#123;s&#125;&quot;</span>, (<span class="string">&quot;p&quot;</span>,pname)(<span class="string">&quot;s&quot;</span>,ex.<span class="built_in">to_string</span>()));</span><br><span class="line">                <span class="built_in">close</span>( conn );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">catch</span> (...) &#123;</span><br><span class="line">                string pname = conn ? conn-&gt;<span class="built_in">peer_name</span>() : <span class="string">&quot;no connection name&quot;</span>;</span><br><span class="line">                <span class="built_in">elog</span>( <span class="string">&quot;Undefined exception hanlding the read data from connection $&#123;p&#125;&quot;</span>,( <span class="string">&quot;p&quot;</span>,pname));</span><br><span class="line">                <span class="built_in">close</span>( conn );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; );</span><br><span class="line">    &#125; <span class="built_in">catch</span> (...) &#123;</span><br><span class="line">        string pname = conn ? conn-&gt;<span class="built_in">peer_name</span>() : <span class="string">&quot;no connection name&quot;</span>;</span><br><span class="line">        <span class="built_in">elog</span>( <span class="string">&quot;Undefined exception handling reading $&#123;p&#125;&quot;</span>,(<span class="string">&quot;p&quot;</span>,pname) );</span><br><span class="line">        <span class="built_in">close</span>( conn );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>抛去其中try catch语句，我们重点看到conn-&gt;process_next_message函数，这个函数正如注释所说，从接受到的pending_message_buffer中处理数据，我们继续追踪这个处理函数，如下所示。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 该函数用于数据同步,使用中心消息处理系统处理数据</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">connection::process_next_message</span><span class="params">(net_plugin_impl&amp; impl, <span class="type">uint32_t</span> message_length)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">auto</span> ds = pending_message_buffer.<span class="built_in">create_datastream</span>();</span><br><span class="line">        net_message msg;</span><br><span class="line">        fc::raw::<span class="built_in">unpack</span>(ds, msg);  <span class="comment">// 将解压的ds信息放入msg中</span></span><br><span class="line">        <span class="function">msg_handler <span class="title">m</span><span class="params">(impl, shared_from_this() )</span></span>;</span><br><span class="line">        <span class="comment">// 判断msg的类型，msg可以是带签名的区块或者打包后的交易</span></span><br><span class="line">        <span class="comment">// 如果是区块，获取signed_block后放入m中</span></span><br><span class="line">        <span class="comment">// 如果是trx，则获取packed_trx后放入m中</span></span><br><span class="line">        <span class="keyword">if</span>( msg.<span class="built_in">contains</span>&lt;signed_block&gt;() ) &#123;</span><br><span class="line">        <span class="built_in">m</span>( std::<span class="built_in">move</span>( msg.<span class="built_in">get</span>&lt;signed_block&gt;() ) );</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>( msg.<span class="built_in">contains</span>&lt;packed_transaction&gt;() ) &#123;</span><br><span class="line">        <span class="built_in">m</span>( std::<span class="built_in">move</span>( msg.<span class="built_in">get</span>&lt;packed_transaction&gt;() ) );</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        msg.<span class="built_in">visit</span>( m );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="built_in">catch</span>(  <span class="type">const</span> fc::exception&amp; e ) &#123;</span><br><span class="line">        <span class="built_in">edump</span>((e.<span class="built_in">to_detail_string</span>() ));</span><br><span class="line">        impl.<span class="built_in">close</span>( <span class="built_in">shared_from_this</span>() );</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中重要的是msg_handler类型，这里面分别针对消息不同的类型做不同的处理，首先查看针对如果msg中包含了signed_block，则进入处理block函数；如果msg中包含packed_transaction，则进入处理trx的函数。首先查看msg_handler是如何处理signed_block的，处理区块的函数如下。收到区块之后验证区块，验证通过则接受区块，验证失败则拒绝区块。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果从网络中收到一个区块，执行相应的处理</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">net_plugin_impl::handle_message</span><span class="params">(<span class="type">const</span> connection_ptr&amp; c, <span class="type">const</span> signed_block_ptr&amp; msg)</span> </span>&#123;</span><br><span class="line">   controller &amp;cc = chain_plug-&gt;<span class="built_in">chain</span>();</span><br><span class="line">   block_id_type blk_id = msg-&gt;<span class="built_in">id</span>();</span><br><span class="line">   <span class="type">uint32_t</span> blk_num = msg-&gt;<span class="built_in">block_num</span>();</span><br><span class="line">   <span class="built_in">fc_dlog</span>(logger, <span class="string">&quot;canceling wait on $&#123;p&#125;&quot;</span>, (<span class="string">&quot;p&quot;</span>,c-&gt;<span class="built_in">peer_name</span>()));</span><br><span class="line">   c-&gt;<span class="built_in">cancel_wait</span>();</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>( cc.<span class="built_in">fetch_block_by_id</span>(blk_id)) &#123;</span><br><span class="line">         <span class="comment">// recv_block函数具体含义为止，同步区块数据？不应该是检查在先？</span></span><br><span class="line">         sync_master-&gt;<span class="built_in">recv_block</span>(c, blk_id, blk_num);</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125; <span class="built_in">catch</span>( ...) &#123;</span><br><span class="line">      <span class="comment">// should this even be caught?</span></span><br><span class="line">      <span class="built_in">elog</span>(<span class="string">&quot;Caught an unknown exception trying to recall blockID&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   dispatcher-&gt;<span class="built_in">recv_block</span>(c, blk_id, blk_num);  <span class="comment">// 进行报告，我已经从连接c收到一个编号blk_id和blk_num的区块？</span></span><br><span class="line">   <span class="function">fc::microseconds <span class="title">age</span><span class="params">( fc::time_point::now() - msg-&gt;timestamp)</span></span>;</span><br><span class="line">   <span class="built_in">peer_ilog</span>(c, <span class="string">&quot;received signed_block : #$&#123;n&#125; block age in secs = $&#123;age&#125;&quot;</span>,</span><br><span class="line">           (<span class="string">&quot;n&quot;</span>,blk_num)(<span class="string">&quot;age&quot;</span>,age.<span class="built_in">to_seconds</span>()));</span><br><span class="line"></span><br><span class="line">   go_away_reason reason = fatal_other;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 在chain_plug中再检查其具体含义，看catch中的内容，应该是使用chain_plug对区块进行检查</span></span><br><span class="line">      <span class="comment">// 如果检查无错误，reason的值应该是no_reason</span></span><br><span class="line">      chain_plug-&gt;<span class="built_in">accept_block</span>(msg); <span class="comment">//, sync_master-&gt;is_active(c));</span></span><br><span class="line">      reason = no_reason;</span><br><span class="line">   &#125; <span class="built_in">catch</span>( <span class="type">const</span> unlinkable_block_exception &amp;ex) &#123;</span><br><span class="line">      <span class="built_in">peer_elog</span>(c, <span class="string">&quot;bad signed_block : $&#123;m&#125;&quot;</span>, (<span class="string">&quot;m&quot;</span>,ex.<span class="built_in">what</span>()));</span><br><span class="line">      reason = unlinkable;</span><br><span class="line">   &#125; <span class="built_in">catch</span>( <span class="type">const</span> block_validate_exception &amp;ex) &#123;</span><br><span class="line">      <span class="built_in">peer_elog</span>(c, <span class="string">&quot;bad signed_block : $&#123;m&#125;&quot;</span>, (<span class="string">&quot;m&quot;</span>,ex.<span class="built_in">what</span>()));</span><br><span class="line">      <span class="built_in">elog</span>( <span class="string">&quot;block_validate_exception accept block #$&#123;n&#125; syncing from $&#123;p&#125;&quot;</span>,(<span class="string">&quot;n&quot;</span>,blk_num)(<span class="string">&quot;p&quot;</span>,c-&gt;<span class="built_in">peer_name</span>()));</span><br><span class="line">      reason = validation;</span><br><span class="line">   &#125; <span class="built_in">catch</span>( <span class="type">const</span> assert_exception &amp;ex) &#123;</span><br><span class="line">      <span class="built_in">peer_elog</span>(c, <span class="string">&quot;bad signed_block : $&#123;m&#125;&quot;</span>, (<span class="string">&quot;m&quot;</span>,ex.<span class="built_in">what</span>()));</span><br><span class="line">      <span class="built_in">elog</span>( <span class="string">&quot;unable to accept block on assert exception $&#123;n&#125; from $&#123;p&#125;&quot;</span>,(<span class="string">&quot;n&quot;</span>,ex.<span class="built_in">to_string</span>())(<span class="string">&quot;p&quot;</span>,c-&gt;<span class="built_in">peer_name</span>()));</span><br><span class="line">   &#125; <span class="built_in">catch</span>( <span class="type">const</span> fc::exception &amp;ex) &#123;</span><br><span class="line">      <span class="built_in">peer_elog</span>(c, <span class="string">&quot;bad signed_block : $&#123;m&#125;&quot;</span>, (<span class="string">&quot;m&quot;</span>,ex.<span class="built_in">what</span>()));</span><br><span class="line">      <span class="built_in">elog</span>( <span class="string">&quot;accept_block threw a non-assert exception $&#123;x&#125; from $&#123;p&#125;&quot;</span>,( <span class="string">&quot;x&quot;</span>,ex.<span class="built_in">to_string</span>())(<span class="string">&quot;p&quot;</span>,c-&gt;<span class="built_in">peer_name</span>()));</span><br><span class="line">      reason = no_reason;</span><br><span class="line">   &#125; <span class="built_in">catch</span>( ...) &#123;</span><br><span class="line">      <span class="built_in">peer_elog</span>(c, <span class="string">&quot;bad signed_block : unknown exception&quot;</span>);</span><br><span class="line">      <span class="built_in">elog</span>( <span class="string">&quot;handle sync block caught something else from $&#123;p&#125;&quot;</span>,(<span class="string">&quot;num&quot;</span>,blk_num)(<span class="string">&quot;p&quot;</span>,c-&gt;<span class="built_in">peer_name</span>()));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function">update_block_num <span class="title">ubn</span><span class="params">(blk_num)</span></span>;</span><br><span class="line">   <span class="keyword">if</span>( reason == no_reason ) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> &amp;recpt : msg-&gt;transactions) &#123;</span><br><span class="line">         <span class="keyword">auto</span> id = (recpt.trx.<span class="built_in">which</span>() == <span class="number">0</span>) ? recpt.trx.<span class="built_in">get</span>&lt;transaction_id_type&gt;() : recpt.trx.<span class="built_in">get</span>&lt;packed_transaction&gt;().<span class="built_in">id</span>();</span><br><span class="line">         <span class="keyword">auto</span> ltx = local_txns.<span class="built_in">get</span>&lt;by_id&gt;().<span class="built_in">find</span>(id);</span><br><span class="line">         <span class="keyword">if</span>( ltx != local_txns.<span class="built_in">end</span>()) &#123;</span><br><span class="line">            local_txns.<span class="built_in">modify</span>( ltx, ubn );</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">auto</span> ctx = c-&gt;trx_state.<span class="built_in">get</span>&lt;by_id&gt;().<span class="built_in">find</span>(id);</span><br><span class="line">         <span class="keyword">if</span>( ctx != c-&gt;trx_state.<span class="built_in">end</span>()) &#123;</span><br><span class="line">            c-&gt;trx_state.<span class="built_in">modify</span>( ctx, ubn );</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 这里再次进行recv_block，不明白其含义</span></span><br><span class="line">      sync_master-&gt;<span class="built_in">recv_block</span>(c, blk_id, blk_num);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 验证区块过程中出现错误，直接拒绝这个区块</span></span><br><span class="line">      sync_master-&gt;<span class="built_in">rejected_block</span>(c, blk_num);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对交易的验证与对区块的处理方式相同，验证交易，如果本地存在此交易，则丢弃，否则开始验证交易，若验证通过则接受交易并广播交易，否则拒绝交易。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">net_plugin_impl::handle_message</span><span class="params">(<span class="type">const</span> connection_ptr&amp; c, <span class="type">const</span> packed_transaction_ptr&amp; trx)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">fc_dlog</span>(logger, <span class="string">&quot;got a packed transaction, cancel wait&quot;</span>);</span><br><span class="line">    <span class="built_in">peer_ilog</span>(c, <span class="string">&quot;received packed_transaction&quot;</span>);</span><br><span class="line">    controller&amp; cc = my_impl-&gt;chain_plug-&gt;<span class="built_in">chain</span>();</span><br><span class="line">    <span class="keyword">if</span>( cc.<span class="built_in">get_read_mode</span>() == eosio::db_read_mode::READ_ONLY ) &#123;</span><br><span class="line">        <span class="built_in">fc_dlog</span>(logger, <span class="string">&quot;got a txn in read-only mode - dropping&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( sync_master-&gt;<span class="built_in">is_active</span>(c) ) &#123;</span><br><span class="line">        <span class="built_in">fc_dlog</span>(logger, <span class="string">&quot;got a txn during sync - dropping&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> ptrx = std::<span class="built_in">make_shared</span>&lt;transaction_metadata&gt;( trx );</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; tid = ptrx-&gt;id;</span><br><span class="line"></span><br><span class="line">    c-&gt;<span class="built_in">cancel_wait</span>();</span><br><span class="line">    <span class="keyword">if</span>(local_txns.<span class="built_in">get</span>&lt;by_id&gt;().<span class="built_in">find</span>(tid) != local_txns.<span class="built_in">end</span>()) &#123;</span><br><span class="line">        <span class="built_in">fc_dlog</span>(logger, <span class="string">&quot;got a duplicate transaction - dropping&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    dispatcher-&gt;<span class="built_in">recv_transaction</span>(c, tid);</span><br><span class="line">    <span class="comment">// 验证交易</span></span><br><span class="line">    chain_plug-&gt;<span class="built_in">accept_transaction</span>(ptrx, [c, <span class="keyword">this</span>, ptrx](<span class="type">const</span> static_variant&lt;fc::exception_ptr, transaction_trace_ptr&gt;&amp; result) &#123;</span><br><span class="line">        <span class="keyword">if</span> (result.<span class="built_in">contains</span>&lt;fc::exception_ptr&gt;()) &#123;</span><br><span class="line">        <span class="built_in">peer_dlog</span>(c, <span class="string">&quot;bad packed_transaction : $&#123;m&#125;&quot;</span>, (<span class="string">&quot;m&quot;</span>,result.<span class="built_in">get</span>&lt;fc::exception_ptr&gt;()-&gt;<span class="built_in">what</span>()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">auto</span> trace = result.<span class="built_in">get</span>&lt;transaction_trace_ptr&gt;();</span><br><span class="line">        <span class="keyword">if</span> (!trace-&gt;except) &#123;</span><br><span class="line">            <span class="built_in">fc_dlog</span>(logger, <span class="string">&quot;chain accepted transaction&quot;</span>);</span><br><span class="line">            <span class="comment">// 广播交易</span></span><br><span class="line">            <span class="keyword">this</span>-&gt;dispatcher-&gt;<span class="built_in">bcast_transaction</span>(ptrx);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">peer_elog</span>(c, <span class="string">&quot;bad packed_transaction : $&#123;m&#125;&quot;</span>, (<span class="string">&quot;m&quot;</span>,trace-&gt;except-&gt;<span class="built_in">what</span>()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 拒绝交易</span></span><br><span class="line">        dispatcher-&gt;<span class="built_in">rejected_transaction</span>(ptrx-&gt;id);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>至此，net_plugin以及net_plugin_impl插件中的比较重要的函数已经分析完毕，由于其中细节错综复杂，因此在分析过程中抓住主要脉络进行分析，对于其他细节内容并没有深究。</p>

      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/03/20/EOS%E4%B8%ADplugin%E4%B9%8Bproducer_plugin/" rel="next" title="EOS中plugin之producer_plugin">
                <i class="fa fa-chevron-left"></i> EOS中plugin之producer_plugin
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/04/08/New%20Empirical%20Traceability%20Analysis%20of%20CryptoNote-Style%20Blockchains/" rel="prev" title="New Empirical Traceability Analysis of CryptoNote-Style Blockchains">
                New Empirical Traceability Analysis of CryptoNote-Style Blockchains <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar2.jpg"
                alt="博主" />
            
              <p class="site-author-name" itemprop="name">博主</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/%20%7C%7C%20archive">
                
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">3</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                    <span class="site-state-item-count">1</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/lastGod" title="GitHub &rarr; https://github.com/lastGod" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.zhihu.com/people/wen-ge-hua-49/activities" title="Zhihu &rarr; https://www.zhihu.com/people/wen-ge-hua-49/activities" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i>Zhihu</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.youtube.com/channel/UCBtnEPEpvAyEGXNarIPzqaA?view_as=subscriber" title="YouTube &rarr; https://www.youtube.com/channel/UCBtnEPEpvAyEGXNarIPzqaA?view_as=subscriber" rel="noopener" target="_blank"><i class="fa fa-fw fa-youtube"></i>YouTube</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://me.csdn.net/t46414704152abc" title="CSDN &rarr; https://me.csdn.net/t46414704152abc" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i>CSDN</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.bilibili.com/video/av37065233" title="bilibili &rarr; https://www.bilibili.com/video/av37065233" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i>bilibili</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://study.163.com/course/courseMain.htm?share=2&shareId=400000000626083&courseId=1006145002&_trace_c_p_k2_=2f085c5758434a769788a6c7a1c88e11" title="NetCloud &rarr; https://study.163.com/course/courseMain.htm?share=2&shareId=400000000626083&courseId=1006145002&_trace_c_p_k2_=2f085c5758434a769788a6c7a1c88e11" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i>NetCloud</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </section>

      

      

<!--背景音乐-->
<!--iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=86 src="//music.163.com/outchain/player?type=2&id=37856454&auto=1&height=66"></iframe> --> 
<!--<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=556319523&auto=1&height=66"></iframe> -->
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=86 src="//music.163.com/outchain/player?type=2&id=4341314&auto=1&height=66"></iframe>

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">博主</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v6.3.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v6.6.0</div>


<div>
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!--注释本行<span id="busuanzi_container_site_pv" style='display:none'>-->
    本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
    <span class="post-meta-divider">|</span>
</span>
<span id="busuanzi_container_site_uv" style='display:none'>
    本站访问<span id="busuanzi_value_site_uv"></span>人次
</span>
</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="Total Visitors">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="Total Views">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.6.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.6.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.6.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.6.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.6.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.6.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  










  





  

  

  

  



  
  

  
  

  


  
  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('Copy')
        }, 300)
      }).append(e)
    })
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


  

</body>
</html>
